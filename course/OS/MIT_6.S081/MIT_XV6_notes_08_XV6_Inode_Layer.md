æœ¬æ–‡ä¸»è¦æ•´ç†Chapter 8 Inode layerçš„è¦ç‚¹ã€‚

## 8.7 Code: Block allocator

### **ç£ç›˜å—ç®¡ç†æœºåˆ¶**
#### 1. **ä½å›¾ï¼ˆBitmapï¼‰ç»“æ„**
   - **å­˜å‚¨ä½ç½®**ï¼šä¸“ç”¨ç£ç›˜å—ï¼ˆç”±`mkfs`åˆå§‹åŒ–ï¼‰  
   - **æ˜ å°„è§„åˆ™**ï¼š  
     - **1 bit â†’ 1ç£ç›˜å—**  
     - `0` = ç©ºé—²å—ï¼Œ`1` = å·²åˆ†é…å—  
   - **åˆå§‹åŒ–è®¾ç½®**ï¼š  
     `mkfs` é¢„å…ˆæ ‡è®°**ä¸å¯åˆ†é…å—**ï¼ˆå¼•å¯¼æ‰‡åŒº/è¶…çº§å—/æ—¥å¿—åŒº/inodeåŒº/ä½å›¾åŒºï¼‰  

#### 2. **å…³é”®å‡½æ•°**
   | **å‡½æ•°**   | **åŠŸèƒ½**                             | **å®ç°è¦ç‚¹**                                                                 |
   |------------|--------------------------------------|-----------------------------------------------------------------------------|
   | `balloc()` | åˆ†é…ç©ºé—²å—                           | 1. æ‰«æä½å›¾å—ï¼Œå¯»æ‰¾é¦–ä¸ª `0` ä½<br>2. æ›´æ–°ä½å›¾ä¸º `1`<br>3. è¿”å›å—å·           |
   | `bfree()`  | é‡Šæ”¾æŒ‡å®šå—                           | 1. å®šä½å—å¯¹åº”çš„ä½å›¾å—<br>2. æ¸…é™¤ä½ï¼ˆç½® `0`ï¼‰<br>3. æ›´æ–°ä½å›¾ç¼“å­˜              |

---

### **åˆ†é…ç®—æ³•ä¼˜åŒ–ï¼ˆballocï¼‰**
#### ğŸ” **åŒå±‚æ‰«æè®¾è®¡**
```c
static uint
balloc(uint dev)
{
  int b, bi, m;
  struct buf *bp;

  bp = 0;
  for(b = 0; b < sb.size; b += BPB){
    bp = bread(dev, BBLOCK(b, sb));
    for(bi = 0; bi < BPB && b + bi < sb.size; bi++){
      m = 1 << (bi % 8);
      if((bp->data[bi/8] & m) == 0){  // Is block free?
        bp->data[bi/8] |= m;  // Mark block in use.
        log_write(bp);
        brelse(bp);
        bzero(dev, b + bi);
        return b + bi;
      }
    }
    brelse(bp);
  }
  printf("balloc: out of blocks\n");
  return 0;
}
```
- **ä¼˜åŒ–ç›®çš„**ï¼šå‡å°‘ç£ç›˜I/O  
  - å¤–å±‚å¾ªç¯æŒ‰**ä½å›¾å—**éå†ï¼ˆå‡å°‘breadè°ƒç”¨æ¬¡æ•°ï¼‰  
  - å†…å±‚å¾ªç¯æ£€æŸ¥å•ä¸ªä½å›¾å—å†…æ‰€æœ‰ä½ï¼ˆå†…å­˜æ“ä½œé«˜æ•ˆï¼‰  
- **æ€§èƒ½æ”¶ç›Š**ï¼š  
  è‹¥æ–‡ä»¶ç³»ç»Ÿæœ‰ 10,000 å—ï¼ˆçº¦ 10 ä½å›¾å—ï¼‰ï¼Œæœ€åæƒ…å†µä»…éœ€ 10 æ¬¡ç£ç›˜è¯»ï¼ˆè€Œé 10,000 æ¬¡ï¼‰  

---

### **å¹¶å‘å®‰å…¨è®¾è®¡**
#### ğŸ”’ **éšå¼é”æœºåˆ¶**
- **ä¾èµ–ç¼“å†²åŒºç¼“å­˜å±‚**ï¼š  
  - `bread()` è·å–ä½å›¾å—æ—¶ï¼Œç¼“å†²åŒºç¡çœ é”**é˜»æ­¢å…¶ä»–è¿›ç¨‹è®¿é—®åŒä¸€å—**  
  - **ä¸´ç•ŒåŒºä¿æŠ¤**ï¼š  
    ```c
    buf = bread(bitmap_bno);  // åŠ é”ï¼ˆå…¶ä»–è¿›ç¨‹é˜»å¡ï¼‰
    ... // ä¿®æ”¹ä½å›¾
    bwrite(buf);             // å†™å›
    brelse(buf);             // é‡Šæ”¾é”
    ```
- **å®‰å…¨æ•ˆæœ**ï¼š  
  é¿å…ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€ä½å›¾å—ï¼ˆå¦‚åŒæ—¶åˆ†é…å—å¯¼è‡´é‡å¤åˆ†é…ï¼‰  

---

### **äº‹åŠ¡æ•´åˆè¦æ±‚**
#### âš ï¸ **å¿…é¡»åŒ…è£¹åœ¨äº‹åŠ¡ä¸­**
```c
begin_op();
bno = balloc(dev);  // åˆ†é…å—
... // ä½¿ç”¨å—ï¼ˆå¦‚å†™æ–‡ä»¶æ•°æ®ï¼‰
end_op();
```
- **å¿…è¦æ€§**ï¼š  
  å—åˆ†é…æ¶‰åŠ**ä½å›¾ä¿®æ”¹**ï¼ˆå…ƒæ•°æ®ï¼‰ï¼Œå¿…é¡»é€šè¿‡æ—¥å¿—ä¿è¯ï¼š  
  1. **åŸå­æ€§**ï¼šåˆ†é…æ“ä½œè¦ä¹ˆå®Œå…¨ç”Ÿæ•ˆï¼ˆä½å›¾æ›´æ–°+å—ä½¿ç”¨ï¼‰ï¼Œè¦ä¹ˆå®Œå…¨å›æ»š  
  2. **å´©æºƒä¸€è‡´æ€§**ï¼šé¿å…ä½å›¾æ›´æ–°åå´©æºƒï¼Œå¯¼è‡´å—å·²åˆ†é…ä½†æœªè¢«ä½¿ç”¨ï¼ˆç©ºé—´æ³„éœ²ï¼‰  

---

> ğŸ’¡ **å…¸å‹åœºæ™¯**ï¼š  
> - **æ–‡ä»¶åˆ›å»º**ï¼š`balloc` åˆ†é… inode å— + æ•°æ®å—  
> - **æ–‡ä»¶åˆ é™¤**ï¼š`bfree` é‡Šæ”¾æ‰€æœ‰å…³è”å—  
> å‡é€šè¿‡æ—¥å¿—äº‹åŠ¡ç¡®ä¿æ“ä½œåŸå­æ€§ï¼Œä»æ ¹æºæœç»å—æ³„éœ²æˆ–é‡å¤åˆ†é…é—®é¢˜ã€‚

## 8.8 Inode layer

### **inodeçš„åŒé‡å«ä¹‰**
| **ç±»å‹**         | **å­˜å‚¨ä½ç½®** | **æ•°æ®ç»“æ„**       | **æ ¸å¿ƒä½œç”¨**                               |
|-------------------|--------------|--------------------|------------------------------------------|
| **ç£ç›˜inode**     | ç£ç›˜å›ºå®šåŒºåŸŸ | `struct dinode`    | æŒä¹…åŒ–å­˜å‚¨æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¤§å°/å—åˆ—è¡¨/ç±»å‹ï¼‰   |
| **å†…å­˜inode**     | å†…å­˜itableè¡¨ | `struct inode`     | è¿è¡Œæ—¶å‰¯æœ¬ï¼ˆå«é¢å¤–æ§åˆ¶å­—æ®µï¼‰               |

---

### **ç£ç›˜inodeç»“æ„ï¼ˆ`struct dinode`ï¼‰**
```c
struct dinode {
  short type;     // æ–‡ä»¶ç±»å‹ï¼ˆ0=ç©ºé—², 1=æ–‡ä»¶, 2=ç›®å½•, 3=è®¾å¤‡ï¼‰
  short nlink;    // ç¡¬é“¾æ¥è®¡æ•°ï¼ˆå†³å®šä½•æ—¶é‡Šæ”¾inodeï¼‰
  uint size;      // æ–‡ä»¶å­—èŠ‚æ•°
  uint addrs[NDIRECT+1]; // æ•°æ®å—åœ°å€ï¼ˆç›´æ¥+é—´æ¥ç´¢å¼•ï¼‰
};
```
- **å…³é”®å­—æ®µ**ï¼š
  - `type=0` â†’ ç©ºé—²inodeï¼ˆå¯åˆ†é…ï¼‰
  - `nlink=0` â†’ æ— ç›®å½•å¼•ç”¨ï¼ˆå¯é‡Šæ”¾æ•°æ®å—ï¼‰
  - `addrs[]` â†’ æ–‡ä»¶å†…å®¹å—ä½ç½®ï¼ˆxv6æ”¯æŒ12ä¸ªç›´æ¥å—+1ä¸ªé—´æ¥å—ï¼‰

---

### **å†…å­˜inodeç»“æ„ï¼ˆ`struct inode`ï¼‰**
```c
struct inode {
  uint dev;           // è®¾å¤‡å·
  uint inum;          // inodeç¼–å·
  int ref;            // å†…å­˜å¼•ç”¨è®¡æ•°
  struct sleeplock lock; // ç¡çœ é”ï¼ˆä¿æŠ¤å­—æ®µä¿®æ”¹ï¼‰
  short type;         // æ‹·è´è‡ªç£ç›˜
  short nlink;         // æ‹·è´è‡ªç£ç›˜
  uint size;          // æ‹·è´è‡ªç£ç›˜
  uint addrs[NDIRECT+1]; // æ‹·è´è‡ªç£ç›˜
};
```
- **æ–°å¢è¿è¡Œæ—¶å­—æ®µ**ï¼š
  - `ref`ï¼šå†…å­˜å¼•ç”¨è®¡æ•°ï¼ˆå½’é›¶æ—¶ä»itableç§»é™¤ï¼‰
  - `lock`ï¼šç¡çœ é”ï¼ˆä¿éšœå­—æ®µè®¿é—®å®‰å…¨ï¼‰

---

### **å››å¤§åŒæ­¥æœºåˆ¶**
| **æœºåˆ¶**               | **ä¿æŠ¤ç›®æ ‡**                                     | **å®ç°æ–¹å¼**                          |
|------------------------|------------------------------------------------|--------------------------------------|
| **itable.lockè‡ªæ—‹é”**  | ç¡®ä¿å†…å­˜inodeå”¯ä¸€æ€§ + `ref`è®¡æ•°å‡†ç¡®æ€§            | ä¿®æ”¹itableæ—¶åŠ é”                     |
| **inodeç¡çœ é”**         | ä¿æŠ¤inodeå­—æ®µåŠæ–‡ä»¶å†…å®¹å—                        | `ilock()`/`iunlock()` åŠ è§£é”         |
| **å†…å­˜å¼•ç”¨è®¡æ•°(ref)**   | ç»´æŒinodeå†…å­˜é©»ç•™ï¼ˆ>0æ—¶ä¸å¯å¤ç”¨ï¼‰                 | `iget()`å¢åŠ  / `iput()`å‡å°‘           |
| **ç£ç›˜é“¾æ¥è®¡æ•°(nlink)**| å†³å®šinodeæ˜¯å¦é‡Šæ”¾ï¼ˆ>0æ—¶ä¸å¯åˆ é™¤ï¼‰                | ç›®å½•æ“ä½œæ—¶æ›´æ–°                       |

| **ç‰¹æ€§**               | **è‡ªæ—‹é” (itable.lock)**                  | **ç¡çœ é” (inode.lock)**               |
|-------------------------|------------------------------------------|---------------------------------------|
| **é˜»å¡è¡Œä¸º**            | å¿™ç­‰å¾…ï¼ˆä¸é‡Šæ”¾CPUï¼‰                      | è®©å‡ºCPUï¼ˆè§¦å‘è¿›ç¨‹åˆ‡æ¢ï¼‰               |
| **æŒæœ‰æ—¶é—´**            | å¿…é¡»æçŸ­ï¼ˆçº³ç§’-å¾®ç§’çº§ï¼‰                  | å¯è¾ƒé•¿ï¼ˆæ¯«ç§’çº§ï¼Œå«I/Oï¼‰               |
| **åµŒå¥—é£é™©**            | ç¦æ­¢åµŒå¥—ï¼ˆä¸´ç•ŒåŒºåŸå­åŒ–ï¼‰                 | éœ€é¡ºåºæ§åˆ¶ï¼ˆå¦åˆ™æ­»é”ï¼‰                |
| **æ­»é”å¯èƒ½æ€§**          | âŒ ä¸å¯èƒ½ï¼ˆæ— é˜»å¡+æ— åµŒå¥—ï¼‰               | âœ… å¯èƒ½ï¼ˆéœ€é¡ºåºæ§åˆ¶ï¼‰                 |

---

### **æ ¸å¿ƒå‡½æ•°å·¥ä½œæµ**
#### ğŸ”„ **1. `iget()` è·å–å†…å­˜inode**
- **ä½œç”¨**ï¼šè¿”å›å†…å­˜inodeæŒ‡é’ˆï¼ˆä¸ä¿è¯æ•°æ®æœ€æ–°ï¼‰
- **ç‰¹æ€§**ï¼š
  - **éç‹¬å **ï¼šå…è®¸å¤šä¸ªè¿›ç¨‹åŒæ—¶æŒæœ‰æŒ‡é’ˆ
  - **å»¶è¿ŸåŠ è½½**ï¼šä¸ç«‹å³è¯»å–ç£ç›˜æ•°æ®
- **ä½¿ç”¨åœºæ™¯**ï¼š
  - é•¿æœŸæŒæœ‰ï¼ˆå¦‚æ‰“å¼€æ–‡ä»¶ï¼‰
  - é¿å…è·¯å¾„æŸ¥æ‰¾æ­»é”

#### ğŸ”’ **2. `ilock()` åŠ è½½å¹¶é”å®šinode**
- **ä½œç”¨**ï¼š
  1. åŠ ç¡çœ é”ï¼ˆé˜»å¡å…¶ä»–è¿›ç¨‹ï¼‰
  2. è‹¥æœªåŠ è½½ â†’ ä»ç£ç›˜è¯»å–`dinode`åˆ°å†…å­˜
- **å…³é”®**ï¼šåˆ†ç¦»`iget`ï¼ˆè·å–å¼•ç”¨ï¼‰å’Œ`ilock`ï¼ˆåŠ è½½æ•°æ®ï¼‰é¿å…æ­»é”

#### ğŸ“¤ **3. `iupdate()` å†™å›ç£ç›˜**
- **ä½œç”¨**ï¼šå°†å†…å­˜inodeåŒæ­¥åˆ°ç£ç›˜
- **è§¦å‘æ¡ä»¶**ï¼šä¿®æ”¹inodeå…ƒæ•°æ®åï¼ˆå¦‚æ–‡ä»¶æˆªæ–­ï¼‰
- **äº‹åŠ¡è¦æ±‚**ï¼šå¿…é¡»åœ¨æ—¥å¿—äº‹åŠ¡ä¸­è°ƒç”¨

#### ğŸ”“ **4. `iput()` é‡Šæ”¾inodeå¼•ç”¨**
- **ä½œç”¨**ï¼š
  1. å‡å°‘`ref`è®¡æ•°
  2. è‹¥`ref=0`ä¸”`nlink=0` â†’ é‡Šæ”¾ç£ç›˜inodeå’Œæ•°æ®å—
  3. ä»itableç§»é™¤
- **è°ƒç”¨æ—¶æœº**ï¼šå…³é—­æ–‡ä»¶/ç›®å½•æ—¶

---

### **è®¾è®¡äº®ç‚¹**
#### ğŸ§  1. **å¼•ç”¨åˆ†ç¦»æœºåˆ¶**
- `iget` åªç®¡ç†**å†…å­˜ç»“æ„ç”Ÿå‘½å‘¨æœŸ**
- `ilock` è´Ÿè´£**æ•°æ®ä¸€è‡´æ€§ä¸äº’æ–¥**
- **ä¼˜åŠ¿**ï¼šé¿å…è·¯å¾„æŸ¥æ‰¾æ—¶æ­»é”ï¼ˆå¦‚è¿›ç¨‹Aé”`/a`ï¼Œè¿›ç¨‹Bé”`/a/b`ï¼‰

#### âš¡ 2. **ç¼“å­˜ä¸æŒä¹…åŒ–åˆ†ç¦»**
- **å†…å­˜inode**ï¼šè¿è¡Œæ—¶æ§åˆ¶ç»“æ„ï¼ˆå«é”/å¼•ç”¨è®¡æ•°ï¼‰
- **ç£ç›˜inode**ï¼šæŒä¹…åŒ–å…ƒæ•°æ®
- **åŒæ­¥**ï¼š`iupdate`æ˜¾å¼å†™å›ï¼ˆé€šå¸¸åœ¨äº‹åŠ¡ä¸­ï¼‰

#### ğŸ”„ 3. **åŒé‡ç”Ÿå‘½å‘¨æœŸç®¡ç†**
| **è®¡æ•°** | **ä½œç”¨åŸŸ** | **å½’é›¶æ¡ä»¶**               | **åæœ**         |
|----------|------------|--------------------------|------------------|
| `ref`    | å†…å­˜       | æ— è¿›ç¨‹å¼•ç”¨inode           | ç§»å‡ºitable       |
| `nlink`  | ç£ç›˜       | æ— ç›®å½•é¡¹æŒ‡å‘è¯¥inode        | é‡Šæ”¾ç£ç›˜ç©ºé—´     |

---

### **å·¥ä½œæµç¤ºä¾‹ï¼šæ‰“å¼€æ–‡ä»¶**
```mermaid
sequenceDiagram
    participant Proc as è¿›ç¨‹
    participant IT as itable
    participant Disk as ç£ç›˜
    
    Proc->>IT: iget(inum) 
    IT-->>Proc: è¿”å› inode* (ref++)
    Proc->>Proc: ilock(inode) 
    alt æ•°æ®æœªåŠ è½½
        Proc->>Disk: è¯»å– dinode
    end
    Proc->>Proc: ä½¿ç”¨æ–‡ä»¶æ•°æ®
    Proc->>Proc: iunlock(inode)
    Proc->>IT: iput(inode) (ref--)
```

---

### **æ€»ç»“**
xv6 inodeå±‚é€šè¿‡ï¼š
1. **å†…å­˜/ç£ç›˜ç»“æ„åˆ†ç¦»** â†’ å…¼é¡¾æ€§èƒ½ä¸æŒä¹…åŒ–  
2. **å››çº§ä¿æŠ¤æœºåˆ¶** â†’ è§£å†³å¹¶å‘å†²çª  
3. **å¼•ç”¨ä¸é”åˆ†ç¦»** â†’ é¿å…æ­»é”  
4. **åŒé‡è®¡æ•°ç®¡ç†** â†’ ç²¾ç¡®æ§åˆ¶èµ„æºç”Ÿå‘½å‘¨æœŸ  
ä¸ºæ–‡ä»¶ç³»ç»Ÿæä¾›äº†é«˜æ•ˆå®‰å…¨çš„å…ƒæ•°æ®ç®¡ç†åŸºç¡€ã€‚

## 8.9 Code: Inodes

### **æ ¸å¿ƒå‡½æ•°åŠŸèƒ½**
| **å‡½æ•°**      | **ä½œç”¨**                           | **å…³é”®æœºåˆ¶**                              |
|---------------|-----------------------------------|------------------------------------------|
| `ialloc()`    | åˆ†é…ç©ºé—²inodeï¼ˆç±»ä¼¼`balloc`ï¼‰       | æ‰«æç£ç›˜inodeåŒº â†’ æ ‡è®°ç±»å‹ â†’ è°ƒç”¨`iget`   |
| `iget()`      | è·å–å†…å­˜inodeå¼•ç”¨                  | æŸ¥itable â†’ å¢`ref` â†’ è®°å½•ç©ºé—²æ§½ä½         |
| `ilock()`     | é”å®šå¹¶åŠ è½½inodeæ•°æ®                | åŠ ç¡çœ é” â†’ ä»ç£ç›˜/ç¼“å­˜è¯»å–å…ƒæ•°æ®          |
| `iput()`      | é‡Šæ”¾inodeå¼•ç”¨                      | å‡`ref` â†’ è‹¥`ref=0 & nlink=0`åˆ™é‡Šæ”¾èµ„æº   |
| `itrunc()`    | é‡Šæ”¾æ–‡ä»¶æ•°æ®å—                     | æ¸…ç©º`addrs[]` â†’ æ›´æ–°ä½å›¾                  |

---

### **å…³é”®è®¾è®¡è§£æ**
#### ğŸ”’ 1. **å¹¶å‘å®‰å…¨æœºåˆ¶**
- **`ialloc` é˜²å†²çª**ï¼š
  - ä¾èµ–**ç¼“å†²åŒºé”**ï¼ˆ`bp->lock`ï¼‰ä¿è¯å•è¿›ç¨‹ä¿®æ”¹inodeç±»å‹ï¼Œäº‹å…ˆè°ƒç”¨ilock(dp)
  - é¿å…ä¸¤è¿›ç¨‹åŒæ—¶è®¤ä¸ºåŒä¸€inodeç©ºé—²

- **`iput` é‡Šæ”¾å®‰å…¨**ï¼š
  - è‹¥ `ref=1 & nlink=0` â†’ ä»…å½“å‰çº¿ç¨‹æŒæœ‰å¼•ç”¨ â†’ æ— å¹¶å‘è®¿é—®é£é™©
  - `ialloc` é‡ç”¨inodeå‰ä¼šç­‰å¾…ç¡çœ é” â†’ ä¸é‡Šæ”¾æ“ä½œäº’æ–¥

#### âš ï¸ 2. **å´©æºƒæ¢å¤ç¼ºé™·**
- **å­¤å„¿inodeé—®é¢˜**ï¼š
  - åœºæ™¯ï¼šæ–‡ä»¶è¢«åˆ ï¼ˆ`nlink=0`ï¼‰ä½†è¿›ç¨‹ä»æ‰“å¼€ï¼ˆ`ref>0`ï¼‰æ—¶å´©æºƒ
  - åæœï¼šç£ç›˜inode**è¢«æ ‡è®°å ç”¨ä½†æ— ç›®å½•é¡¹æŒ‡å‘** â†’ ç©ºé—´æ³„éœ²
- **xv6çš„ä¸è¶³**ï¼š
  - âŒ æœªè®°å½•å¾…é‡Šæ”¾inodeåˆ—è¡¨
  - âŒ é‡å¯åæ— æ‰«æå›æ”¶æœºåˆ¶
  - é£é™©ï¼šé•¿æœŸè¿è¡Œå¯èƒ½å¯¼è‡´ç£ç›˜è€—å°½

#### ğŸ’¾ 3. **å†™ç›˜è§¦å‘æ¡ä»¶**
- **éšå¼å†™æ“ä½œ**ï¼š
  ```c
  read() â†’ æ‰“å¼€æ–‡ä»¶ â†’ ... â†’ å…³é—­æ–‡ä»¶ â†’ iput() â†’ è‹¥nlink=0 â†’ itrunc() â†’ å†™ä½å›¾
  ```
  - **å…³é”®ç»“è®º**ï¼šå³ä½¿**åªè¯»æ“ä½œ**ä¹Ÿå¯èƒ½è§¦å‘ç£ç›˜å†™ï¼ˆé€šè¿‡`iput`ï¼‰
- **äº‹åŠ¡å¿…è¦æ€§**ï¼š
  - æ‰€æœ‰æ–‡ä»¶æ“ä½œå¿…é¡»åŒ…è£¹åœ¨äº‹åŠ¡ä¸­ï¼š
    ```c
    begin_op();
    read(fd, buf, n); // å¯èƒ½è°ƒç”¨iput()
    end_op();
    ```

---

### **èµ„æºé‡Šæ”¾æµç¨‹ï¼ˆ`iput`ï¼‰**
```mermaid
sequenceDiagram
    participant Caller as è°ƒç”¨è€…
    participant IPUT as iput()
    participant FS as æ–‡ä»¶ç³»ç»Ÿ
    
    Caller->>IPUT: iput(ip)
    IPUT->>IPUT: ref--
    alt ref==0 && nlink==0
        IPUT->>FS: itrunc(ip)  // é‡Šæ”¾æ•°æ®å—
        IPUT->>FS: ip->type=0  // æ ‡è®°ç©ºé—²
        IPUT->>FS: iupdate(ip) // å†™å›ç£ç›˜
    end
    IPUT->>FS: ç§»é™¤itableæ¡ç›®
```

### **è®¾è®¡å±€é™ä¸æ”¹è¿›æ–¹å‘**
| **é—®é¢˜**                | **xv6å¤„ç†**      | **å·¥ä¸šçº§æ–¹æ¡ˆ**               |
|-------------------------|-----------------|-----------------------------|
| **å­¤å„¿inode**           | âŒ å¿½ç•¥          | ç£ç›˜è®°å½•å¾…é‡Šæ”¾åˆ—è¡¨ + å›æ”¶æ‰«æ |
| **å³æ—¶é‡Šæ”¾**            | âœ… ç«‹å³æ‰§è¡Œ      | å»¶è¿Ÿåˆ é™¤ï¼ˆé¿å…é¢‘ç¹å…ƒæ•°æ®å†™ï¼‰  |
| **äº‹åŠ¡åŒ…è£¹åªè¯»æ“ä½œ**    | âœ… å¼ºåˆ¶è¦æ±‚      | å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰é¿å…äº‹åŠ¡      |
| **å¤§æ–‡ä»¶æˆªæ–­**          | âŒ åŒæ­¥é˜»å¡      | å¼‚æ­¥é‡Šæ”¾ + åå°å›æ”¶          |

---

### **æ€»ç»“**
xv6 inodeå±‚é€šè¿‡ï¼š
1. **åˆ†å±‚é”æœºåˆ¶**ï¼ˆè‡ªæ—‹é”ä¿å­˜åœ¨æ€§ + ç¡çœ é”ä¿æ•°æ®ï¼‰
2. **åŒé‡è®¡æ•°**ï¼ˆ`ref`å†…å­˜å¼•ç”¨ + `nlink`ç£ç›˜é“¾æ¥ï¼‰
3. **äº‹åŠ¡æ•´åˆ**ï¼ˆæ‰€æœ‰æ“ä½œåŒ…è£¹æ—¥å¿—ï¼‰
å®ç°åŸºç¡€çš„æ–‡ä»¶å…ƒæ•°æ®ç®¡ç†ï¼Œä½†å­˜åœ¨ï¼š
- å­¤å„¿inodeæ³„éœ²é£é™©
- é‡Šæ”¾æ“ä½œç¼ºä¹å¼¹æ€§
- æœªä¼˜åŒ–åªè¯»è·¯å¾„

## 8.10 Code: Inode content

### **ç£ç›˜inodeç»“æ„ï¼ˆ`struct dinode`ï¼‰**
```c
struct dinode {
  short type;
  short nlink;
  uint size;
  uint addrs[NDIRECT + 1]; // æ•°æ®å—åœ°å€æ•°ç»„
};
```
- **å—æ˜ å°„æœºåˆ¶**ï¼š
  | **å—ç±»å‹**      | **å­˜å‚¨ä½ç½®**               | **å®¹é‡**                     | **è®¿é—®æ–¹å¼**              |
  |-----------------|---------------------------|-----------------------------|--------------------------|
  | **ç›´æ¥å—**       | `addrs[0..NDIRECT-1]`     | `NDIRECTÃ—BSIZE`ï¼ˆ12KBï¼‰     | ç›´æ¥ç´¢å¼•                  |
  | **é—´æ¥å—**       | `addrs[NDIRECT]` æŒ‡å‘çš„å—   | `NINDIRECTÃ—BSIZE`ï¼ˆ256KBï¼‰  | äºŒçº§ç´¢å¼•                  |
  | **æœ€å¤§æ–‡ä»¶**     | -                         | 268KBï¼ˆ12+256ï¼‰             | -                        |

> ğŸ“Œ **xv6å…¸å‹å€¼**ï¼š  
> `NDIRECT=12`, `BSIZE=1024` â†’ ç›´æ¥å—æ”¯æŒ12KB  
> `NINDIRECT=256` â†’ é—´æ¥å—æ”¯æŒ256KB

```
inode (dinode)
-----------------
| size         |
| addrs[0]     | ----> æ•°æ®å—0
| ...          |
| addrs[11]    | ----> æ•°æ®å—11ï¼ˆç›´æ¥å—ï¼‰
| addrs[12]    | ----> é—´æ¥å—
                 |
                 |
                 v
                é—´æ¥å—ï¼ˆæ•°æ®å—ï¼‰
                -----------------
                | å—åœ°å€0     | ----> æ•°æ®å—12
                | å—åœ°å€1     | ----> æ•°æ®å—13
                | ...        |
                | å—åœ°å€255   | ----> æ•°æ®å—267
                -----------------
```
---

### **æ ¸å¿ƒå‡½æ•°è§£æ**
#### ğŸ” 1. **`bmap()`ï¼šé€»è¾‘å—åˆ°ç‰©ç†å—æ˜ å°„**
```c
// kernel/fs.c:383
static uint bmap(struct inode *ip, uint bn) {
  if (bn < NDIRECT) {
    // ç›´æ¥å—å¤„ç†
    if (ip->addrs[bn] == 0) 
      ip->addrs[bn] = balloc(ip->dev); // æŒ‰éœ€åˆ†é…
    return ip->addrs[bn];
  } 
  bn -= NDIRECT;
  if (bn < NINDIRECT) {
    // é—´æ¥å—å¤„ç†
    if (ip->addrs[NDIRECT] == 0) 
      ip->addrs[NDIRECT] = balloc(ip->dev); // åˆ†é…é—´æ¥å—
    
    struct buf *bp = bread(ip->dev, ip->addrs[NDIRECT]);
    uint *indirect = (uint*)bp->data;
    if (indirect[bn] == 0) 
      indirect[bn] = balloc(ip->dev); // åˆ†é…æ•°æ®å—
    
    bwrite(bp);
    brelse(bp);
    return indirect[bn];
  }
  panic("bmap: out of range");
}
```

#### ğŸ—‘ï¸ 2. **`itrunc()`ï¼šé‡Šæ”¾æ–‡ä»¶æ‰€æœ‰å—**
```c
// kernel/fs.c:426
void itrunc(struct inode *ip) {
  // é‡Šæ”¾ç›´æ¥å—
  for (int i = 0; i < NDIRECT; i++) {
    if (ip->addrs[i]) {
      bfree(ip->dev, ip->addrs[i]);
      ip->addrs[i] = 0;
    }
  }
  
  // é‡Šæ”¾é—´æ¥å—
  if (ip->addrs[NDIRECT]) {
    struct buf *bp = bread(ip->dev, ip->addrs[NDIRECT]);
    uint *indirect = (uint*)bp->data;
    for (int i = 0; i < NINDIRECT; i++) {
      if (indirect[i]) 
        bfree(ip->dev, indirect[i]);
    }
    brelse(bp);
    bfree(ip->dev, ip->addrs[NDIRECT]); // é‡Šæ”¾é—´æ¥å—æœ¬èº«
    ip->addrs[NDIRECT] = 0;
  }
  
  ip->size = 0;
  iupdate(ip);
}
```
- **é‡Šæ”¾é¡ºåº**ï¼š  
  1. ç›´æ¥å—ï¼ˆ12ä¸ªï¼‰  
  2. é—´æ¥å—æŒ‡å‘çš„æ‰€æœ‰æ•°æ®å—ï¼ˆ256ä¸ªï¼‰  
  3. é—´æ¥å—æœ¬èº«  

#### ğŸ“– 3. **`readi()`ï¼šæ–‡ä»¶è¯»å–**
```c
// kernel/fs.c:472
int
readi(struct inode *ip, int user_dst, uint64 dst, uint off, uint n)
{
  uint tot, m;
  struct buf *bp;

  if(off > ip->size || off + n < off)
    return 0;
  if(off + n > ip->size)
    n = ip->size - off;

  for(tot=0; tot<n; tot+=m, off+=m, dst+=m){
    uint addr = bmap(ip, off/BSIZE);
    if(addr == 0)
      break;
    bp = bread(ip->dev, addr);
    m = min(n - tot, BSIZE - off%BSIZE);
    if(either_copyout(user_dst, dst, bp->data + (off % BSIZE), m) == -1) {
      brelse(bp);
      tot = -1;
      break;
    }
    brelse(bp);
  }
  return tot;
}
turn n;
}
```
- **å…³é”®é€»è¾‘**ï¼š  
  - è¶Šç•Œå¤„ç†ï¼šè¶…èŒƒå›´è¿”å›é”™è¯¯ï¼Œæœ«å°¾æˆªæ–­  
  - åˆ†å—æ‹·è´ï¼šå¤„ç†è·¨å—è¯»å–  
  - ä¾èµ– `bmap` è½¬æ¢é€»è¾‘ä½ç½®  

#### ğŸ“ 4. **`writei()`ï¼šæ–‡ä»¶å†™å…¥**
```c
// kernel/fs.c:506
int writei(struct inode *ip, char *src, uint off, uint n) {
  // è¾¹ç•Œæ£€æŸ¥ï¼ˆæ”¯æŒæ‰©å±•ï¼‰
  if (off > ip->size || off + n < off) 
    return -1;
  if (off + n > MAXFILE*BSIZE) 
    return -1;  // è¶…è¿‡æœ€å¤§æ–‡ä»¶
  
  // é€å—å†™å…¥
  for (uint tot = 0; tot < n; ) {
    uint bno = bmap(ip, off / BSIZE);  // å¯èƒ½åˆ†é…æ–°å—
    struct buf *bp = bread(ip->dev, bno);
    uint m = min(n - tot, BSIZE - off%BSIZE);
    memmove(bp->data + off%BSIZE, src + tot, m);
    bwrite(bp);  // å†™å›ä¿®æ”¹
    brelse(bp);
    tot += m;
    off += m;
  }
  
  // æ›´æ–°æ–‡ä»¶å¤§å°
  if (off > ip->size) {
    ip->size = off;
    iupdate(ip);  // å†™å›inodeå…ƒæ•°æ®
  }
  return n;
}
```
- **æ‰©å±•ç‰¹æ€§**ï¼š  
  - å†™å…¥è¶…å‡ºæ–‡ä»¶æœ«å°¾ â†’ è‡ªåŠ¨æ‰©å±•  
  - æ›´æ–° `ip->size` å¹¶å†™å›ç£ç›˜  

#### ğŸ“‹ 5. **`stati()`ï¼šè·å–æ–‡ä»¶å…ƒæ•°æ®**
```c
// kernel/fs.c:458
void stati(struct inode *ip, struct stat *st) {
  st->dev = ip->dev;
  st->ino = ip->inum;
  st->type = ip->type;
  st->nlink = ip->nlink;
  st->size = ip->size;
}
```
- **ç”¨æˆ·æ¥å£**ï¼š  
  é€šè¿‡ `stat` ç³»ç»Ÿè°ƒç”¨æš´éœ²ç»™ç”¨æˆ·ç¨‹åº  

---

### **è®¾è®¡äº®ç‚¹**
1. **æŒ‰éœ€åˆ†é…**  
   - `bmap` åŠ¨æ€åˆ†é…å— â†’ èŠ‚çœç£ç›˜ç©ºé—´  
   - å°æ–‡ä»¶æ— éœ€é—´æ¥å—ï¼ˆé›¶å¼€é”€ï¼‰  

2. **ç»Ÿä¸€è®¿é—®æ¥å£**  
   - `readi`/`writei` éšè—å—æ˜ å°„ç»†èŠ‚  
   - æ”¯æŒéšæœºè®¿é—®ï¼ˆé€šè¿‡ `off` å‚æ•°ï¼‰  

3. **è¾¹ç•Œå®‰å…¨**  
   - è¯»å†™å‰æ£€æŸ¥ `off` å’Œ `size`  
   - å†™æ“ä½œé™åˆ¶ `MAXFILE`ï¼ˆé˜²æº¢å‡ºï¼‰  

4. **å—å¯¹é½ä¼˜åŒ–**  
   - åˆ†å—å¤„ç†è·¨å—æ“ä½œ  
   - `min(n - tot, BSIZE - off%BSIZE)` ç²¾ç¡®è®¡ç®—æ‹·è´é‡  

---

### **æ€§èƒ½æƒè¡¡**
| **æ“ä½œ**       | **ç›´æ¥å—è®¿é—®**         | **é—´æ¥å—è®¿é—®**               |
|----------------|----------------------|----------------------------|
| **è¯»å–æˆæœ¬**   | 1æ¬¡ç£ç›˜è¯»            | 2æ¬¡ç£ç›˜è¯»ï¼ˆé—´æ¥å—+æ•°æ®å—ï¼‰   |
| **å†™å…¥æˆæœ¬**   | 1æ¬¡ç£ç›˜å†™            | 2æ¬¡ç£ç›˜å†™ï¼ˆæ›´æ–°é—´æ¥å—ï¼‰     |
| **åˆ†é…å¼€é”€**   | O(1)                | O(1) + é—´æ¥å—åˆ†é…          |

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼š  
> å°†å°æ–‡ä»¶ï¼ˆ<12KBï¼‰å­˜å‚¨åœ¨ç›´æ¥å—ä¸­ï¼Œé¿å…é—´æ¥è®¿é—®å¼€é”€ã€‚

---

### **æ€»ç»“**
xv6 inodeå†…å®¹å±‚é€šè¿‡ï¼š
1. **ä¸¤çº§ç´¢å¼•ç»“æ„**ï¼ˆç›´æ¥+é—´æ¥ï¼‰â†’ å¹³è¡¡å°æ–‡ä»¶æ•ˆç‡ä¸å¤§æ–‡ä»¶æ”¯æŒ  
2. **æŒ‰éœ€åˆ†é…ç­–ç•¥**ï¼ˆ`bmap`ï¼‰â†’ åŠ¨æ€ç®¡ç†ç£ç›˜ç©ºé—´  
3. **ç»Ÿä¸€è¯»å†™æ¥å£**ï¼ˆ`readi`/`writei`ï¼‰â†’ ç®€åŒ–æ–‡ä»¶æ“ä½œ  
4. **è¾¹ç•Œå®‰å…¨æ§åˆ¶** â†’ é˜²æ­¢è¶Šç•Œè®¿é—®  
å®ç°äº†é«˜æ•ˆå¯é çš„æ–‡ä»¶å†…å®¹ç®¡ç†ï¼Œä¸ºæ–‡ä»¶ç³»ç»Ÿæä¾›äº†æ ¸å¿ƒæ•°æ®å­˜å–èƒ½åŠ›ã€‚


## ialloc/bmapå…³ç³»

åœ¨xv6æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ`ialloc` å’Œ `bmap` æ˜¯ä¸¤ä¸ªç´§å¯†åä½œä½†èŒè´£ä¸åŒçš„å…³é”®å‡½æ•°ï¼Œå…±åŒç®¡ç†æ–‡ä»¶çš„å­˜å‚¨èµ„æºã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„è¯¦ç»†å…³ç³»åˆ†æï¼š

---

### **æ ¸å¿ƒèŒè´£å¯¹æ¯”**
| **å‡½æ•°**   | **ä½œç”¨å¯¹è±¡** | **åŠŸèƒ½**                           | **èµ„æºç±»å‹**      |
|------------|--------------|-----------------------------------|-------------------|
| `ialloc()` | **inode**    | åˆ†é…ç©ºé—²inodeï¼ˆå…ƒæ•°æ®ï¼‰             | inodeç£ç›˜æ§½ä½     |
| `bmap()`   | **æ•°æ®å—**    | åˆ†é…æ–‡ä»¶æ•°æ®å—ï¼ˆå†…å®¹å­˜å‚¨ï¼‰           | æ–‡ä»¶æ•°æ®å—        |

---

### **åä½œæµç¨‹ï¼ˆä»¥åˆ›å»ºæ–‡ä»¶ä¸ºä¾‹ï¼‰**
```mermaid
sequenceDiagram
    participant Syscall as ç³»ç»Ÿè°ƒç”¨
    participant Inode as inodeå±‚
    participant Block as å—å±‚
    
    Syscall->>Inode: create("/test.txt")
    Inode->>Inode: ialloc() // åˆ†é…inode
    Note right of Inode: 1. æ‰«æä½å›¾æ‰¾ç©ºé—²inode<br>2. æ ‡è®°type=T_FILE<br>3. åˆå§‹åŒ–nlink=1
    Inode->>Inode: iget() // è·å–å†…å­˜inode
    
    Syscall->>Inode: write(fd, buf, len)
    Inode->>Block: bmap(ip, bn) // åˆ†é…æ•°æ®å—
    Note right of Block: 1. è‹¥ç›´æ¥å—æœªåˆ†é…â†’balloc()<br>2. è‹¥éœ€é—´æ¥å—â†’é€’å½’åˆ†é…
    Block->>Inode: è¿”å›ç‰©ç†å—å·
    Inode->>Block: æ•°æ®å†™å…¥ç¼“å†²åŒº
    Inode->>Inode: iupdate() // æ›´æ–°inodeå…ƒæ•°æ®
```

---

### **ä¾èµ–å…³ç³»**
1. **`ialloc` ä¾èµ– `balloc`**  
   - ä¿®æ”¹inodeä½å›¾æ—¶éœ€è°ƒç”¨ `balloc` åˆ†é…ä½å›¾å—ï¼ˆè‹¥æœªç¼“å­˜ï¼‰  
   - é€šè¿‡ `log_write` è®°å½•ä½å›¾ä¿®æ”¹ï¼ˆäº‹åŠ¡ä¿æŠ¤ï¼‰  

2. **`bmap` ä¾èµ– `balloc`**  
   - é‡æœªåˆ†é…å—æ—¶ç›´æ¥è°ƒç”¨ `balloc` è·å–æ–°å—  
   - æ›´æ–°é—´æ¥å—æ—¶éœ€å†™å›ç£ç›˜ï¼ˆ`bwrite`ï¼‰  

3. **`bmap` æœåŠ¡æ–‡ä»¶æ“ä½œ**  
   - `readi`/`writei` é€šè¿‡ `bmap` è·å–ç‰©ç†å—å·  
   - æ–‡ä»¶æ‰©å±•æ—¶è§¦å‘ `bmap` åˆ†é…æ–°å—  

---

### **è®¾è®¡åˆ†ç¦»çš„æ„ä¹‰**
1. **èµ„æºè§£è€¦**  
   - inodeç®¡ç†ï¼ˆ`ialloc`ï¼‰ä¸æ•°æ®å—ç®¡ç†ï¼ˆ`bmap`ï¼‰åˆ†ç¦»  
   - ç¬¦åˆæ–‡ä»¶ç³»ç»Ÿåˆ†å±‚è®¾è®¡ï¼ˆå…ƒæ•°æ® vs æ•°æ®ï¼‰  

2. **å¤ç”¨æ€§æå‡**  
   - `bmap` è¢«æ‰€æœ‰æ–‡ä»¶æ“ä½œå¤ç”¨ï¼ˆè¯»/å†™/æˆªæ–­ï¼‰  
   - `ialloc` ä¸“æ³¨inodeç”Ÿå‘½å‘¨æœŸç®¡ç†  

3. **äº‹åŠ¡æ•´åˆ**  
   - ä¸¤è€…å‡åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ï¼ˆ`begin_op`/`end_op`ï¼‰  
   - å…±äº«æ—¥å¿—å±‚å´©æºƒä¿æŠ¤  

---

### **å…¸å‹è°ƒç”¨é“¾**
#### ğŸ“ æ–‡ä»¶å†™å…¥åœºæ™¯
```c
begin_op();
  ip = create("test.txt"); // å†…éƒ¨è°ƒç”¨ialloc+iget
  writei(ip, buf, off, n); // å†…éƒ¨å¾ªç¯è°ƒç”¨bmap
end_op();
```

#### ğŸ—‘ï¸ æ–‡ä»¶åˆ é™¤åœºæ™¯
```c
begin_op();
  ilock(ip);
  ip->nlink--;          // å‡å°‘é“¾æ¥
  iupdate(ip);          // å†™å›inode
  itrunc(ip);           // å†…éƒ¨è°ƒç”¨bmapé‡Šæ”¾å—
  iput(ip);             // è‹¥nlink=0åˆ™é‡Šæ”¾inode
end_op();
```

---

### **æ€»ç»“**
`ialloc` å’Œ `bmap` æ˜¯xv6æ–‡ä»¶ç³»ç»Ÿçš„**èµ„æºåˆ†é…åŒæ ¸å¿ƒ**ï¼š  
- `ialloc` â†’ **å…ƒæ•°æ®ç®¡å®¶**ï¼šè´Ÿè´£inodeåˆ†é…ä¸åˆå§‹åŒ–  
- `bmap` â†’ **æ•°æ®å¯¼èˆªä»ª**ï¼šè´Ÿè´£æ–‡ä»¶å—æ˜ å°„ä¸æ‰©å±•  
ä¸¤è€…é€šè¿‡**äº‹åŠ¡æ—¥å¿—**ååŒï¼Œç¡®ä¿æ–‡ä»¶æ“ä½œçš„åŸå­æ€§ï¼Œå…±åŒæ„å»ºäº†xv6æ–‡ä»¶å­˜å‚¨çš„åŸºç¡€è®¾æ–½ã€‚