æœ¬æ–‡ä¸»è¦æ•´ç†pytorch-paligemmaçš„ä¸»è¦å†…å®¹ã€‚

## 1 - Contractive pre-training

### å†…å®¹æ¦‚å†µ
1.  **æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•è®­ç»ƒä¸€ä¸ªæ¨¡åž‹ï¼Œä½¿å…¶èƒ½å¤Ÿç†è§£å›¾åƒå’Œæ–‡æœ¬çš„å¯¹åº”å…³ç³»ï¼Ÿå³ï¼Œç»™å®šä¸€æ‰¹`ï¼ˆå›¾åƒï¼Œæ–‡æœ¬ï¼‰`é…å¯¹æ•°æ®ï¼Œè®©æ¨¡åž‹å­¦ä¼šå°†é…å¯¹çš„å›¾åƒå’Œæ–‡æœ¬åœ¨ç‰¹å¾ç©ºé—´ä¸­å¯¹é½ï¼Œå¹¶æ‹‰è¿œä¸é…å¯¹æ ·æœ¬çš„è·ç¦»ã€‚
2.  **è§£å†³æ–¹æ¡ˆ**ï¼šé‡‡ç”¨**å¯¹æ¯”å­¦ä¹ **æ¡†æž¶ã€‚å°†å›¾åƒå’Œæ–‡æœ¬åˆ†åˆ«é€šè¿‡ç¼–ç å™¨æ˜ å°„åˆ°**åŒä¸€ä¸ªå¤šæ¨¡æ€åµŒå…¥ç©ºé—´**ï¼Œå¹¶è®¡ç®—æ‰€æœ‰å›¾åƒ-æ–‡æœ¬å¯¹ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œå½¢æˆä¸€ä¸ªç›¸ä¼¼åº¦çŸ©é˜µã€‚è®­ç»ƒç›®æ ‡æ˜¯è®©**å¯¹è§’çº¿**ä¸Šï¼ˆæ­£ç¡®é…å¯¹ï¼‰çš„ç›¸ä¼¼åº¦å°½å¯èƒ½é«˜ï¼Œè€Œéžå¯¹è§’çº¿ä¸Šçš„ç›¸ä¼¼åº¦å°½å¯èƒ½ä½Žã€‚
3.  **å…³é”®æŠ€æœ¯**ï¼šä½¿ç”¨**å¯¹ç§°çš„äº¤å‰ç†µæŸå¤±**æ¥å®žçŽ°ä¸Šè¿°ç›®æ ‡ï¼Œå°†é—®é¢˜å·§å¦™åœ°è½¬åŒ–ä¸ºä¸€ä¸ªâ€œåˆ†ç±»â€ä»»åŠ¡ã€‚

### è¦ç‚¹æ€»ç»“
1.  **åŒå¡”æž¶æž„**ï¼šæ¨¡åž‹åŒ…å«ç‹¬ç«‹çš„å›¾åƒç¼–ç å™¨ï¼ˆå¦‚ResNetã€ViTï¼‰å’Œæ–‡æœ¬ç¼–ç å™¨ï¼ˆå¦‚Transformerï¼‰ï¼Œä¸¤è€…ä¸ç›´æŽ¥äº¤äº’ï¼Œä»…åœ¨æœ€åŽè¿›è¡Œç‰¹å¾å¯¹æ¯”ã€‚
2.  **å…±äº«åµŒå…¥ç©ºé—´**ï¼šå›¾åƒå’Œæ–‡æœ¬ç‰¹å¾é€šè¿‡å¯å­¦ä¹ çš„æŠ•å½±å±‚è¢«æ˜ å°„åˆ°å…·æœ‰**ç›¸åŒç»´åº¦**çš„åµŒå…¥å‘é‡ï¼Œå¹¶ç»è¿‡L2å½’ä¸€åŒ–ï¼Œä½¿ç›¸ä¼¼åº¦è®¡ç®—è½¬åŒ–ä¸º**ä½™å¼¦ç›¸ä¼¼åº¦**ã€‚
3.  **ç›¸ä¼¼åº¦çŸ©é˜µ**ï¼šè®¡ç®—ä¸€ä¸ªæ‰¹æ¬¡å†…æ‰€æœ‰å›¾åƒåµŒå…¥å’Œæ–‡æœ¬åµŒå…¥çš„**ç‚¹ç§¯**ï¼Œå½¢æˆä¸€ä¸ª $n x n$ çš„ç›¸ä¼¼åº¦çŸ©é˜µï¼ˆ$n$ä¸ºæ‰¹æ¬¡å¤§å°ï¼‰ã€‚çŸ©é˜µçš„ $[i, j]$ å…ƒç´ ä»£è¡¨ç¬¬$i$å¼ å›¾ä¸Žç¬¬$j$æ®µæ–‡æœ¬çš„åŒ¹é…åˆ†æ•°ã€‚
4.  **å¯¹ç§°äº¤å‰ç†µæŸå¤±**ï¼š
    *   ä»Ž**å›¾åƒè§†è§’**çœ‹ï¼šå°†ç¬¬$i$å¼ å›¾ä¸Žæ‰€æœ‰æ–‡æœ¬çš„ç›¸ä¼¼åº¦è§†ä¸ºä¸€ä¸ªæ¦‚çŽ‡åˆ†å¸ƒï¼Œç›®æ ‡æ˜¯è®©ä¸Žå®ƒé…å¯¹çš„ç¬¬$i$ä¸ªæ–‡æœ¬çš„æ¦‚çŽ‡æœ€é«˜ã€‚è¿™å¯¹åº”äºŽå¯¹ç›¸ä¼¼åº¦çŸ©é˜µçš„**æ¯ä¸€è¡Œ**ï¼ˆ`axis=1`ï¼‰è®¡ç®—äº¤å‰ç†µæŸå¤±ã€‚
    *   ä»Ž**æ–‡æœ¬è§†è§’**çœ‹ï¼šå°†ç¬¬$j$æ®µæ–‡æœ¬ä¸Žæ‰€æœ‰å›¾åƒçš„ç›¸ä¼¼åº¦è§†ä¸ºä¸€ä¸ªæ¦‚çŽ‡åˆ†å¸ƒï¼Œç›®æ ‡æ˜¯è®©ä¸Žå®ƒé…å¯¹çš„ç¬¬$j$å¼ å›¾çš„æ¦‚çŽ‡æœ€é«˜ã€‚è¿™å¯¹åº”äºŽå¯¹ç›¸ä¼¼åº¦çŸ©é˜µçš„**æ¯ä¸€åˆ—**ï¼ˆ`axis=0`ï¼‰è®¡ç®—äº¤å‰ç†µæŸå¤±ã€‚
    *   æœ€ç»ˆçš„æŸå¤±æ˜¯è¿™ä¸¤ä¸ªæ–¹å‘æŸå¤±çš„å¹³å‡å€¼ã€‚è¿™è¿«ä½¿æ¨¡åž‹åœ¨**åŒå‘**ä¸Šéƒ½å®žçŽ°ç²¾å‡†åŒ¹é…ã€‚
5.  **æ¸©åº¦å‚æ•°**ï¼šç›¸ä¼¼åº¦åœ¨è®¡ç®—æŸå¤±å‰ä¼šä¹˜ä»¥ä¸€ä¸ªå¯å­¦ä¹ çš„æ¸©åº¦å‚æ•° $t$ çš„æŒ‡æ•° `np.exp(t)`ã€‚è¿™ä¸ªå‚æ•°**ç¼©æ”¾**å¯¹æ•°å‡ çŽ‡ï¼Œå¸®åŠ©æ¨¡åž‹ä¼˜åŒ–ç›¸ä¼¼åº¦çš„æ•°å€¼èŒƒå›´ï¼Œæ˜¯å¯¹æ¯”å­¦ä¹ ä¸­çš„å…³é”®è¶…å‚æ•°ã€‚

### æºç è§£é‡Šï¼ˆç»“åˆç¬¬äºŒå¼ å›¾ä¼ªä»£ç ï¼‰
```python
# 1. ç‰¹å¾æå–
I_f = image_encoder(I) # [n, d_i] å›¾åƒç¼–ç å™¨æå–ç‰¹å¾
T_f = text_encoder(T)  # [n, d_t] æ–‡æœ¬ç¼–ç å™¨æå–ç‰¹å¾

# 2. æŠ•å½±ä¸Žå½’ä¸€åŒ–ï¼ˆæž„å»ºå…±äº«åµŒå…¥ç©ºé—´ï¼‰
I_e = l2_normalize(np.dot(I_f, W_i), axis=1) # [n, d_e] æŠ•å½±åŽL2å½’ä¸€åŒ–
T_e = l2_normalize(np.dot(T_f, W_t), axis=1) # [n, d_e] æŠ•å½±åŽL2å½’ä¸€åŒ–
# ç›®çš„ï¼šç¡®ä¿å›¾åƒå’Œæ–‡æœ¬åµŒå…¥ç»´åº¦ç›¸åŒï¼Œä¸”æ¨¡é•¿ä¸º1ï¼Œæ­¤æ—¶ç‚¹ç§¯å³ä¸ºä½™å¼¦ç›¸ä¼¼åº¦ã€‚

# 3. è®¡ç®—ç¼©æ”¾çš„ç›¸ä¼¼åº¦çŸ©é˜µï¼ˆå¯¹æ•°å‡ çŽ‡ï¼‰
logits = np.dot(I_e, T_e.T) * np.exp(t) # [n, n]
# è®¡ç®—æ‰€æœ‰å›¾åƒå’Œæ–‡æœ¬åµŒå…¥ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œå½¢æˆnÃ—nçŸ©é˜µã€‚
# ä¹˜ä»¥ np.exp(t) è¿›è¡Œç¼©æ”¾ï¼Œtæ˜¯å¯å­¦ä¹ çš„æ¸©åº¦å‚æ•°ã€‚

# 4. è®¡ç®—å¯¹ç§°å¯¹æ¯”æŸå¤±
labels = np.arange(n) # æ­£ç¡®é…å¯¹çš„ä¸‹æ ‡ï¼Œå³å¯¹è§’çº¿ä½ç½® [0, 1, 2, ..., n-1]

# å›¾åƒåˆ°æ–‡æœ¬çš„æŸå¤±ï¼šé’ˆå¯¹æ¯ä¸€å¼ å›¾ï¼ˆæ¯ä¸€è¡Œï¼‰ï¼Œçœ‹å®ƒåŒ¹é…å“ªä¸ªæ–‡æœ¬ã€‚
loss_i = cross_entropy_loss(logits, labels, axis=0) # æ²¿åˆ—ï¼ˆæ–‡æœ¬ç»´åº¦ï¼‰è®¡ç®—Softmaxå’Œäº¤å‰ç†µ
# æ–‡æœ¬åˆ°å›¾åƒçš„æŸå¤±ï¼šé’ˆå¯¹æ¯ä¸€æ®µæ–‡æœ¬ï¼ˆæ¯ä¸€åˆ—ï¼‰ï¼Œçœ‹å®ƒåŒ¹é…å“ªå¼ å›¾ã€‚
loss_t = cross_entropy_loss(logits, labels, axis=1) # æ²¿è¡Œï¼ˆå›¾åƒç»´åº¦ï¼‰è®¡ç®—Softmaxå’Œäº¤å‰ç†µ

# æ€»æŸå¤±ä¸ºä¸¤ä¸ªæ–¹å‘æŸå¤±çš„å¹³å‡
loss = (loss_i + loss_t)/2
```
**æ ¸å¿ƒç†è§£**ï¼šè¿™é‡Œçš„ `cross_entropy_loss` æ“ä½œï¼Œå®žè´¨ä¸Šæ˜¯å¯¹ `logits` çŸ©é˜µçš„æ¯ä¸€è¡Œï¼ˆæˆ–åˆ—ï¼‰è¿›è¡Œ **Softmax** æ“ä½œï¼Œå°†å…¶è½¬åŒ–ä¸ºä¸€ä¸ªæ¦‚çŽ‡åˆ†å¸ƒï¼Œç„¶åŽè®¡ç®—ä¸Ž `labels`ï¼ˆå³å¯¹è§’çº¿ä½ç½®ï¼‰çš„æ ‡å‡†äº¤å‰ç†µæŸå¤±ã€‚è¿™ç›´æŽ¥å¯¹åº”äº†ç¬¬ä¸€å¼ å›¾ä¸­â€œå¸Œæœ›æ¯è¡Œ/åˆ—ä¸­åªæœ‰ä¸€ä¸ªæœ€å¤§å€¼â€çš„ç›´è§‚æè¿°ã€‚

### æ€»ç»“
è¿™ä¸¤å¼ å›¾ç”ŸåŠ¨åœ°è¯´æ˜Žï¼ŒCLIPé€šè¿‡ä¸€ç§**å¯¹ç§°çš„ã€åŸºäºŽæ‰¹å†…è´Ÿæ ·æœ¬çš„å¯¹æ¯”å­¦ä¹ **æ–¹æ³•ï¼Œå°†æµ·é‡çš„äº’è”ç½‘ï¼ˆå›¾åƒï¼Œæ–‡æœ¬ï¼‰å¯¹ä½œä¸ºç›‘ç£ä¿¡å·ï¼Œè®­ç»ƒå‡ºäº†ä¸€ä¸ªå¼ºå¤§çš„å¤šæ¨¡æ€åŸºç¡€æ¨¡åž‹ã€‚å…¶å…³é”®åˆ›æ–°åœ¨äºŽå°†çœ‹ä¼¼å¤æ‚çš„å¤šæ¨¡æ€åŒ¹é…é—®é¢˜ï¼Œä¼˜é›…åœ°è½¬åŒ–ä¸ºä¸€ä¸ªåœ¨å…±äº«åµŒå…¥ç©ºé—´ä¸­çš„**å¯¹æ¯”åˆ†ç±»**é—®é¢˜ï¼Œå¹¶é€šè¿‡é«˜æ•ˆçš„çŸ©é˜µè¿ç®—å’Œå¯¹ç§°æŸå¤±å‡½æ•°å®žçŽ°ã€‚

## 2.0 - sigmoidæ›¿ä»£softmax

### å†…å®¹æ¦‚å†µ

ä¸‰å¼ å›¾ç‰‡å…±åŒæŽ¢è®¨äº†åœ¨è®­ç»ƒç±»ä¼¼CLIPçš„åŒå¡”å¼æ¨¡åž‹æ—¶ï¼Œæ ¸å¿ƒçš„**å¯¹æ¯”æŸå¤±å‡½æ•°**åœ¨å®žçŽ°ä¸­é‡åˆ°çš„æŒ‘æˆ˜åŠå…¶è§£å†³æ–¹æ¡ˆã€‚

1.  **ç¬¬ä¸€å¼ å›¾** é˜è¿°äº†æœ€åŸºç¡€çš„ **Softmax å‡½æ•°å­˜åœ¨æ•°å€¼ä¸ç¨³å®šæ€§** è¿™ä¸€æ ¹æœ¬é—®é¢˜ã€‚å› ä¸ºæŒ‡æ•°å‡½æ•°å¢žé•¿æžå¿«ï¼Œåœ¨è®¡ç®—ä¸­å®¹æ˜“å¯¼è‡´æµ®ç‚¹æ•°æº¢å‡ºï¼ˆå¦‚ $exp(1000)$ ç»“æžœè¿‡å¤§ï¼‰ï¼Œä½¿å¾—è®­ç»ƒæ— æ³•è¿›è¡Œã€‚
2.  **ç¬¬äºŒå¼ å›¾** æŒ‡å‡ºäº†åœ¨CLIPçš„**å¯¹ç§°å¯¹æ¯”æŸå¤±**å…·ä½“åº”ç”¨ä¸­ï¼Œç”±äºŽéœ€è¦ä»Žâ€œå›¾åƒåˆ°æ–‡æœ¬â€å’Œâ€œæ–‡æœ¬åˆ°å›¾åƒâ€ä¸¤ä¸ªæ–¹å‘åˆ†åˆ«è®¡ç®—Softmaxï¼Œ**å½’ä¸€åŒ–è®¡ç®—é‡è¾ƒå¤§**ï¼Œä¸”å¼ºè°ƒäº†è¿™ç§å¯¹ç§°æ€§æ˜¯å®žçŽ°æœ‰æ•ˆå¯¹é½çš„å…³é”®ã€‚
3.  **ç¬¬ä¸‰å¼ å›¾** åˆ™æå‡ºäº†ä¸€ä¸ªæ›´ä¼˜çš„æ›¿ä»£æ–¹æ¡ˆï¼š**ä½¿ç”¨Sigmoidå‡½æ•°å–ä»£Softmaxæ¥æž„å»ºå¯¹æ¯”æŸå¤±**ã€‚è¿™ç§æ–¹æ³•ä»Žæ ¹æœ¬ä¸Šé¿å…äº†Softmaxæ‰€éœ€çš„å…¨å±€å½’ä¸€åŒ–ï¼Œä»Žè€Œè§£å†³äº†æ•°å€¼ç¨³å®šæ€§å’Œè®¡ç®—æ•ˆçŽ‡çš„é—®é¢˜ï¼Œæ˜¯å‰ä¸¤å¼ å›¾æ‰€è¿°é—®é¢˜çš„å·¥ç¨‹è§£å†³æ–¹æ¡ˆã€‚

### è¦ç‚¹æ€»ç»“

1.  **æ ¸å¿ƒé—®é¢˜ï¼šSoftmaxçš„æ•°å€¼ä¸ç¨³å®šæ€§**
    *   **åŽŸç†**ï¼šSoftmaxå‡½æ•° $S_i = exp(a_i) / Î£ exp(a_k)$ ä¸­çš„æŒ‡æ•°è¿ç®— $exp(a_i)$ åœ¨è¾“å…¥ $a_i$ è¾ƒå¤§æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªå·¨å¤§çš„æ•°å€¼ï¼Œå¯èƒ½è¶…å‡ºè®¡ç®—æœºæµ®ç‚¹æ•°çš„è¡¨ç¤ºèŒƒå›´ï¼ˆæº¢å‡ºï¼‰ï¼Œå¯¼è‡´ç»“æžœä¸ºæ— ç©·å¤§ï¼ˆ$inf$ï¼‰æˆ–è®­ç»ƒå´©æºƒã€‚
    *   **é€šç”¨è§£æ³•**ï¼šå¯¹è¾“å…¥è¿›è¡Œå¹³ç§»ã€‚åœ¨è®¡ç®—Softmaxå‰ï¼Œä»¤æ¯ä¸ªè¾“å…¥ $a_i$ éƒ½å‡åŽ»æ•´ä¸ªå‘é‡ä¸­çš„æœ€å¤§å€¼ $max(a_k)$ã€‚è¿™ä½¿å¾—æœ€å¤§çš„æŒ‡æ•°é¡¹å˜ä¸º $exp(0)=1$ï¼Œå…¶ä½™ä¸º $exp(è´Ÿæ•°)$ï¼Œä»Žè€Œå°†æ‰€æœ‰æŒ‡æ•°ç»“æžœé™åˆ¶åœ¨ $(0, 1]$ åŒºé—´ï¼Œç¡®ä¿æ•°å€¼ç¨³å®šã€‚è¿™æ˜¯æ·±åº¦å­¦ä¹ ä¸­çš„æ ‡å‡†å®žè·µã€‚

2.  **åº”ç”¨åœºæ™¯ï¼šCLIPçš„å¯¹ç§°å¯¹æ¯”æŸå¤±**
    *   **å¯¹ç§°æ€§**ï¼šCLIPçš„æŸå¤±ä¸æ˜¯å•ä¸€çš„Softmaxï¼Œè€Œæ˜¯ä¸¤ä¸ªæ–¹å‘SoftmaxæŸå¤±çš„å¹³å‡å€¼ã€‚å¯¹äºŽä¸€ä¸ªæ‰¹æ¬¡å†…çš„æ ·æœ¬ï¼Œæ—¢è¦è®¡ç®—æ¯å¼ å›¾ç‰‡ä¸Žæ‰€æœ‰æ–‡æœ¬åŒ¹é…çš„æ¦‚çŽ‡åˆ†å¸ƒï¼ˆå›¾åƒâ†’æ–‡æœ¬ï¼‰ï¼Œä¹Ÿè¦è®¡ç®—æ¯æ®µæ–‡æœ¬ä¸Žæ‰€æœ‰å›¾ç‰‡åŒ¹é…çš„æ¦‚çŽ‡åˆ†å¸ƒï¼ˆæ–‡æœ¬â†’å›¾åƒï¼‰ã€‚
    *   **è®¡ç®—å¼€é”€**ï¼šè¿™ç§å¯¹ç§°æ€§æ„å‘³ç€éœ€è¦ä¸ºæ‰¹æ¬¡ä¸­çš„æ¯ä¸ªæ ·æœ¬ï¼ˆå›¾åƒå’Œæ–‡æœ¬ï¼‰è®¡ç®—ä¸¤æ¬¡å½’ä¸€åŒ–å› å­ï¼ˆåˆ†æ¯çš„æ±‚å’Œï¼‰ï¼Œè®¡ç®—é‡éšæ‰¹æ¬¡å¤§å°å¢žé•¿ã€‚

3.  **ä¼˜åŒ–æ–¹æ¡ˆï¼šé‡‡ç”¨Sigmoidäº¤å‰ç†µæŸå¤±**
    *   **æ€è·¯è½¬å˜**ï¼šä¸å†å°†é—®é¢˜è§†ä¸ºâ€œä¸€ä¸ªæ ·æœ¬ä¸Žä¸€ä¸ªæ‰¹æ¬¡å†…æ‰€æœ‰æ ·æœ¬ç«žäº‰â€çš„å¤šç±»åˆ†ç±»ï¼ˆSoftmaxï¼‰ï¼Œè€Œæ˜¯å°†å…¶è½¬åŒ–ä¸ºæ‰¹æ¬¡å†…**æ‰€æœ‰å¯èƒ½çš„å›¾åƒ-æ–‡æœ¬å¯¹**çš„**ç‹¬ç«‹äºŒåˆ†ç±»**é—®é¢˜ï¼šåˆ¤æ–­æ¯ä¸€å¯¹ $(I_i, T_j)$ æ˜¯æ­£ç¡®é…å¯¹ï¼ˆæ­£æ ·æœ¬ï¼‰è¿˜æ˜¯é”™è¯¯é…å¯¹ï¼ˆè´Ÿæ ·æœ¬ï¼‰ã€‚
    *   **æŸå¤±å…¬å¼**ï¼šå¦‚ç¬¬ä¸‰å¼ å›¾æ‰€ç¤ºï¼Œæ€»æŸå¤±æ˜¯æ‰¹æ¬¡å†…æ‰€æœ‰ $N x N$ ä¸ªé…å¯¹ï¼ˆ$N$ä¸ºæ‰¹æ¬¡å¤§å°ï¼‰çš„äºŒåˆ†ç±»æŸå¤±ä¹‹å’Œã€‚å¯¹äºŽä¸€å¯¹ $(i, j)$ï¼Œå…¶æŸå¤± $L_ij$ æ˜¯åŸºäºŽå…¶ç›¸ä¼¼åº¦ $t * x_i Â· y_j$ çš„Sigmoidäº¤å‰ç†µæŸå¤±ã€‚æ ‡ç­¾ $z_ij$ åœ¨ $i=j$ï¼ˆæ­£å¯¹ï¼‰æ—¶ä¸º1ï¼Œå¦åˆ™ä¸º-1ã€‚
    *   **ä¼˜åŠ¿**ï¼š
        *   **æ•°å€¼ç¨³å®š**ï¼šSigmoidå‡½æ•°æœ¬èº«è¾“å‡ºèŒƒå›´åœ¨(0,1)ï¼Œä¸”å…¶è¾“å…¥ï¼ˆå¯¹æ•°å‡ çŽ‡ï¼‰æ²¡æœ‰æŒ‡æ•°çˆ†ç‚¸é£Žé™©ã€‚
        *   **è®¡ç®—é«˜æ•ˆ**ï¼šæ¯ä¸ªé…å¯¹ç‹¬ç«‹è®¡ç®—ï¼Œæ— éœ€åœ¨æ•´ä¸ªæ‰¹æ¬¡ä¸Šè¿›è¡Œæ˜‚è´µçš„å…¨å±€å½’ä¸€åŒ–ï¼ˆæ±‚å’Œï¼‰ã€‚
        *   **çµæ´»æ€§**ï¼šå¯ä»¥è½»æ¾èžå…¥é¢å¤–çš„è´Ÿæ ·æœ¬æˆ–å¤„ç†éžå¯¹ç§°çš„æ‰¹æ¬¡å¤§å°ã€‚

**æ€»ç»“è€Œè¨€ï¼Œè¿™ä¸‰å¼ å›¾æ­ç¤ºäº†ä¸€ä¸ªä»Žç†è®ºé—®é¢˜åˆ°å·¥ç¨‹å®žè·µçš„å®Œæ•´é“¾æ¡ï¼šè¯†åˆ«å‡ºSoftmaxçš„å›ºæœ‰é—®é¢˜ â†’ ç†è§£å…¶åœ¨å¯¹ç§°å¯¹æ¯”å­¦ä¹ ä¸­çš„å…·ä½“è¡¨çŽ° â†’ æœ€ç»ˆé‡‡çº³æ›´é²æ£’ã€é«˜æ•ˆçš„Sigmoidäº¤å‰ç†µæŸå¤±ä½œä¸ºè§£å†³æ–¹æ¡ˆã€‚è¿™æ­£æ˜¯CLIPåŠå…¶åŽç»­è®¸å¤šå¯¹æ¯”å­¦ä¹ æ¨¡åž‹å®žé™…é‡‡ç”¨çš„è®­ç»ƒç­–ç•¥ã€‚**

## 2.1 - sigmoidå‚æ•°tå’Œb

### **$t$ï¼ˆæ¸©åº¦å‚æ•°ï¼ŒTemperatureï¼‰**
- **ä½œç”¨**ï¼šç¼©æ”¾ç›¸ä¼¼åº¦åˆ†æ•° $x_i Â· y_j$ï¼ˆå³å›¾åƒå’Œæ–‡æœ¬åµŒå…¥çš„ç‚¹ç§¯/ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ã€‚å®ƒæ˜¯ä¸€ä¸ª **å¯å­¦ä¹ çš„æ ‡é‡å‚æ•°**ã€‚
- **åŠŸèƒ½**ï¼š
  - æŽ§åˆ¶ç›¸ä¼¼åº¦åˆ†å¸ƒçš„â€œå°–é”â€ç¨‹åº¦ï¼š$t$ å€¼è¾ƒå°æ—¶ï¼Œç›¸ä¼¼åº¦å·®å¼‚ä¼šè¢«æ”¾å¤§ï¼Œä½¿å¾—æ­£æ ·æœ¬å¯¹å’Œè´Ÿæ ·æœ¬å¯¹çš„åŒºåˆ†æ›´æ˜Žæ˜¾ï¼›$t$ å€¼è¾ƒå¤§æ—¶ï¼Œåˆ†å¸ƒæ›´å¹³æ»‘ï¼Œæ¨¡åž‹å¯¹ç›¸ä¼¼åº¦å·®å¼‚æ›´ä¸æ•æ„Ÿã€‚
  - å¸®åŠ©æ¨¡åž‹ç¨³å®šä¼˜åŒ–ï¼šåœ¨å¯¹æ¯”å­¦ä¹ ä¸­ï¼Œæ¸©åº¦å‚æ•°èƒ½è‡ªé€‚åº”åœ°è°ƒæ•´æ¢¯åº¦å¤§å°ï¼Œé˜²æ­¢è®­ç»ƒåˆæœŸå› ç›¸ä¼¼åº¦æ•°å€¼è¿‡å¤§æˆ–è¿‡å°è€Œå¯¼è‡´çš„æ¢¯åº¦çˆ†ç‚¸æˆ–æ¶ˆå¤±é—®é¢˜ã€‚
- **åœ¨å…¬å¼ä¸­ä½“çŽ°**ï¼š$-t * x_i Â· y_j$ éƒ¨åˆ†ï¼Œå°†åŽŸå§‹ç›¸ä¼¼åº¦ç¼©æ”¾åŽä½œä¸º Sigmoid å‡½æ•°çš„è¾“å…¥ã€‚

### **$b$ï¼ˆåç½®é¡¹ï¼ŒBiasï¼‰**
- **ä½œç”¨**ï¼šä¸ºç›¸ä¼¼åº¦åˆ†æ•°æ·»åŠ ä¸€ä¸ªå¯å­¦ä¹ çš„åç§»é‡ï¼Œå……å½“åˆ¤æ–­é…å¯¹æ­£è´Ÿçš„ **è‡ªé€‚åº”é˜ˆå€¼**ã€‚
- **åŠŸèƒ½**ï¼š
  - è°ƒæ•´äºŒåˆ†ç±»çš„å†³ç­–è¾¹ç•Œï¼šæ¨¡åž‹é€šè¿‡ $b$ å­¦ä¹ åˆ°ä¸€ä¸ªåˆé€‚çš„é˜ˆå€¼ï¼Œä½¿å¾— $t * x_i Â· y_j - b > 0$ æ—¶å€¾å‘äºŽé¢„æµ‹ä¸ºæ­£æ ·æœ¬å¯¹ï¼Œåä¹‹åˆ™ä¸ºè´Ÿæ ·æœ¬å¯¹ã€‚
  - å¢žå¼ºæ¨¡åž‹çµæ´»æ€§ï¼šç”±äºŽä¸åŒæ•°æ®é›†æˆ–ä»»åŠ¡ä¸­ç›¸ä¼¼åº¦çš„åˆ†å¸ƒå¯èƒ½ä¸åŒï¼Œåç½®é¡¹å…è®¸æ¨¡åž‹è‡ªè¡Œå­¦ä¹ æœ€ä½³çš„é˜ˆå€¼ä½ç½®ï¼Œè€Œä¸å¿…å›ºå®šä¸º0ã€‚
- **åœ¨å…¬å¼ä¸­ä½“çŽ°**ï¼šä¸Žç¼©æ”¾åŽçš„ç›¸ä¼¼åº¦ç›¸åŠ ï¼Œå½¢æˆ $-t * x_i Â· y_j + b$ï¼Œå…±åŒå½±å“ Sigmoid å‡½æ•°çš„è¾“å…¥å€¼ã€‚

### **ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬ï¼Ÿ**
1. **ä¼˜åŒ–ç¨³å®šæ€§**ï¼š$t$ å’Œ $b$ ä½¿æ¨¡åž‹èƒ½å¤ŸåŠ¨æ€è°ƒæ•´ç›¸ä¼¼åº¦åˆ†æ•°çš„èŒƒå›´å’Œåç§»ï¼Œç¡®ä¿ Sigmoid å‡½æ•°çš„è¾“å…¥è½åœ¨æ•æ„ŸåŒºé—´ï¼ˆå³æ¢¯åº¦è¾ƒå¤§åŒºåŸŸï¼‰ï¼Œé¿å…é¥±å’ŒåŒºï¼ˆæ¢¯åº¦æŽ¥è¿‘0ï¼‰ï¼Œä»Žè€Œæå‡è®­ç»ƒæ•ˆçŽ‡ã€‚
2. **ä»»åŠ¡è‡ªé€‚åº”**ï¼šä¸åŒæ¨¡æ€ï¼ˆå¦‚å›¾åƒå’Œæ–‡æœ¬ï¼‰çš„åµŒå…¥åˆ†å¸ƒå¯èƒ½å­˜åœ¨å›ºæœ‰å·®å¼‚ï¼Œ$t$ å’Œ $b$ å…è®¸æ¨¡åž‹è‡ªåŠ¨æ ¡å‡†ï¼Œæ›´å¥½åœ°å¯¹é½å¤šæ¨¡æ€ç‰¹å¾ã€‚
3. **ç»Ÿä¸€æ­£è´Ÿæ ·æœ¬ä¼˜åŒ–**ï¼šå…¬å¼ä¸­çš„ $z_{ij}$ï¼ˆæ­£æ ·æœ¬å¯¹ä¸º+1ï¼Œè´Ÿæ ·æœ¬å¯¹ä¸º-1ï¼‰ä¸Ž $-t * x_i Â· y_j + b$ ç›¸ä¹˜ï¼Œä½¿å¾—æ­£æ ·æœ¬å¯¹éœ€è¦è¾ƒå¤§çš„ç›¸ä¼¼åº¦ï¼ˆ$x_i Â· y_j$ å¤§ï¼‰ï¼Œè´Ÿæ ·æœ¬å¯¹éœ€è¦è¾ƒå°çš„ç›¸ä¼¼åº¦ï¼ˆ$x_i Â· y_j$ å°ï¼‰ï¼Œè€Œ $t$ å’Œ $b$ å…±åŒè°ƒæŽ§è¿™ä¸€è¿‡ç¨‹çš„ä¸¥æ ¼ç¨‹åº¦ã€‚

### **ä¸Žå›¾ç‰‡å…¶ä»–éƒ¨åˆ†çš„å…³è”**
- **å·¦ä¾§çŸ©é˜µ**ï¼šå±•ç¤ºäº†æ‰¹æ¬¡å†…æ‰€æœ‰å›¾åƒ-æ–‡æœ¬å¯¹ï¼ˆ$I_j$ ä¸Ž $T_i$ï¼‰ã€‚$t$ å’Œ $b$ çš„ä½œç”¨æ­£æ˜¯åœ¨è®¡ç®—æ¯ä¸ªæ ¼å­ $(i, j)$ çš„æŸå¤± $L_{ij}$ æ—¶ï¼Œè°ƒæ•´å…¶ç›¸ä¼¼åº¦å¾—åˆ†ï¼Œä»Žè€Œå½±å“æ¨¡åž‹å¯¹æ­£è´Ÿæ ·æœ¬å¯¹çš„åŒºåˆ†èƒ½åŠ›ã€‚
- **å³ä¾§ Sigmoid å‡½æ•°å›¾åƒ**ï¼šç›´è§‚æ˜¾ç¤ºäº† $Ï†(z) = 1 / (1 + e^{-z})$ çš„å½¢çŠ¶ï¼Œå…¶ä¸­ $z = z_{ij} * (-t * x_i Â· y_j + b)$ã€‚$t$ å’Œ $b$ çš„å˜åŒ–ä¼šæ”¹å˜ $z$ çš„åˆ†å¸ƒï¼Œä»Žè€Œå½±å“ Sigmoid è¾“å‡ºçš„æ¦‚çŽ‡å€¼ï¼Œæœ€ç»ˆå†³å®šæŸå¤±å¤§å°ã€‚

æ€»ä¹‹ï¼Œ$t$ å’Œ $b$ æ˜¯ä½¿ Sigmoid äº¤å‰ç†µæŸå¤±çµæ´»é€‚åº”å¯¹æ¯”å­¦ä¹ ä»»åŠ¡çš„å…³é”®å¯å­¦ä¹ å‚æ•°ï¼Œå®ƒä»¬ååŒå·¥ä½œï¼Œå¸®åŠ©æ¨¡åž‹é«˜æ•ˆåŒºåˆ†æ­£è´Ÿæ ·æœ¬å¯¹ï¼Œå®žçŽ°å¤šæ¨¡æ€ç‰¹å¾çš„ç²¾å‡†å¯¹é½ã€‚

## 3.0 SiglipVisionEmbeddingsæºç åˆ†æž

è¿™æ˜¯ä¸€ä¸ªå…¸åž‹çš„è§†è§‰Transformerï¼ˆVision Transformer, ViTï¼‰åµŒå…¥å±‚å®žçŽ°ï¼Œç”¨äºŽå°†å›¾åƒè½¬æ¢ä¸ºé€‚åˆTransformeræ¨¡åž‹å¤„ç†çš„åºåˆ—åŒ–åµŒå…¥è¡¨ç¤ºã€‚

### 1. ç±»å®šä¹‰ä¸Žåˆå§‹åŒ–

```python
class SiglipVisionEmbeddings(nn.Module):
    def __init__(self, config: SiglipVisionConfig):
        super().__init__()
        self.config = config
        self.embed_dim = config.hidden_size  # åµŒå…¥ç»´åº¦ï¼ˆå¦‚1152ï¼‰
        self.image_size = config.image_size  # è¾“å…¥å›¾åƒå°ºå¯¸ï¼ˆå¦‚384ï¼‰
        self.patch_size = config.patch_size  #  patchå¤§å°ï¼ˆå¦‚14ï¼‰
```

**åˆå§‹åŒ–å‚æ•°è¯´æ˜Žï¼š**
- `hidden_size`ï¼šæ¯ä¸ªpatchåµŒå…¥å‘é‡çš„ç»´åº¦ï¼Œå†³å®šäº†æ¨¡åž‹çš„è¡¨ç¤ºèƒ½åŠ›
- `image_size`å’Œ`patch_size`ï¼šå…±åŒå†³å®šäº†å°†å›¾åƒåˆ†å‰²æˆå¤šå°‘ä¸ªpatch

### 2. PatchåµŒå…¥å±‚ï¼ˆæ ¸å¿ƒç»„ä»¶ï¼‰

```python
self.patch_embedding = nn.Conv2d(
    in_channels=config.num_channels,  # è¾“å…¥é€šé“æ•°ï¼ˆRGBä¸º3ï¼‰
    out_channels=self.embed_dim,     # è¾“å‡ºé€šé“æ•°=åµŒå…¥ç»´åº¦
    kernel_size=self.patch_size,    # å·ç§¯æ ¸å¤§å°=patchå¤§å°
    stride=self.patch_size,         # æ­¥é•¿=patchå¤§å°ï¼ˆç¡®ä¿ä¸é‡å ï¼‰
    padding="valid",                # æ— å¡«å……
)
```

**å…³é”®æŠ€æœ¯ç‰¹ç‚¹ï¼š**
- **å·ç§¯æ“ä½œå®žçŽ°åˆ†å—**ï¼šä½¿ç”¨ä¸Žpatchå¤§å°ç›¸åŒçš„å·ç§¯æ ¸å’Œæ­¥é•¿ï¼Œç›´æŽ¥å°†å›¾åƒåˆ†å‰²ä¸ºä¸é‡å çš„patch
- **ç»´åº¦å˜æ¢**ï¼šå°†æ¯ä¸ªpatchçš„åƒç´ å€¼æ˜ å°„åˆ°é«˜ç»´åµŒå…¥ç©ºé—´
- **é«˜æ•ˆæ€§**ï¼šå•æ¬¡å·ç§¯æ“ä½œå®Œæˆæ‰€æœ‰patchçš„åµŒå…¥æå–

### 3. ä½ç½®ç¼–ç è®¡ç®—

```python
self.num_patches = (self.image_size // self.patch_size) ** 2  # æ€»patchæ•°é‡
self.num_positions = self.num_patches
self.position_embedding = nn.Embedding(self.num_positions, self.embed_dim)

# ç¤ºä¾‹ï¼šimage_size=384, patch_size=14 â†’ num_patchesâ‰ˆ754
```

**ä½ç½®ç¼–ç çš„é‡è¦æ€§ï¼š**
- **å¼¥è¡¥ç©ºé—´ä¿¡æ¯ä¸¢å¤±**ï¼šTransformeræœ¬èº«ä¸å…·å¤‡ä½ç½®æ„ŸçŸ¥èƒ½åŠ›ï¼Œéœ€è¦æ˜¾å¼æ·»åŠ ä½ç½®ä¿¡æ¯
- **å¯å­¦ä¹ å‚æ•°**ï¼šä½ç½®åµŒå…¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ å¾—åˆ°ï¼Œè€Œéžä½¿ç”¨å›ºå®šçš„æ­£å¼¦ç¼–ç 

### 4. å‰å‘ä¼ æ’­è¿‡ç¨‹

#### 4.1 PatchåµŒå…¥æå–
```python
patch_embeds = self.patch_embedding(pixel_values)  # å½¢çŠ¶è½¬æ¢ç¤ºä¾‹
# è¾“å…¥: [Batch_Size, 3, 384, 384]
# è¾“å‡º: [Batch_Size, 1152, 27, 27]ï¼ˆ27=384/14ï¼‰
```

#### 4.2 åºåˆ—åŒ–å¤„ç†
```python
embeddings = patch_embeds.flatten(2)          # å±•å¹³ç©ºé—´ç»´åº¦
# å½¢çŠ¶: [Batch_Size, 1152, 729]ï¼ˆ729=27Ã—27ï¼‰

embeddings = embeddings.transpose(1, 2)       # è°ƒæ•´ç»´åº¦é¡ºåº
# æœ€ç»ˆå½¢çŠ¶: [Batch_Size, 729, 1152]
```

#### 4.3 ä½ç½®ä¿¡æ¯æ·»åŠ 
```python
embeddings = embeddings + self.position_embedding(self.position_ids)
# ä½ç½®ç¼–ç å½¢çŠ¶: [1, 729, 1152] â†’ é€šè¿‡å¹¿æ’­åŠ åˆ°æ¯ä¸ªæ ·æœ¬
```

### 5. è¾“å‡ºç»“æžœ

**æœ€ç»ˆè¾“å‡ºç»´åº¦**ï¼š`[Batch_Size, Num_Patches, Embed_Dim]`
- å®Œç¾Žé€‚é…Transformerç¼–ç å™¨çš„è¾“å…¥è¦æ±‚
- æ¯ä¸ªpatchå¯¹åº”ä¸€ä¸ªåµŒå…¥å‘é‡ï¼Œæ•´ä¸ªå›¾åƒè½¬æ¢ä¸ºåºåˆ—åŒ–è¡¨ç¤º

## 3.1 SiglipMLP geluåŽŸç†åˆ†æž

`nn.functional.gelu(hidden_states, approximate="tanh")` æ˜¯ PyTorch ä¸­é«˜æ–¯è¯¯å·®çº¿æ€§å•å…ƒï¼ˆGaussian Error Linear Unit, GELUï¼‰æ¿€æ´»å‡½æ•°çš„ä¸€ç§**è¿‘ä¼¼è®¡ç®—å®žçŽ°**ã€‚ä¸‹é¢ä¸ºä½ è§£é‡Šå…¶å·¥ä½œåŽŸç†ã€æ•°å­¦å…¬å¼ä»¥åŠä¸ºä½•ä½¿ç”¨è¿™ç§è¿‘ä¼¼æ–¹æ³•ã€‚

### âš™ï¸ GELU çš„æ•°å­¦ç›´è§‰

GELU çš„æ ¸å¿ƒæ€æƒ³æ˜¯**æ ¹æ®è¾“å…¥å€¼çš„å¤§å°ï¼Œå¯¹å…¶è¿›è¡Œéšæœºé—¨æŽ§**ã€‚å…·ä½“æ¥è¯´ï¼š

- å¯¹äºŽæ¯ä¸ªè¾“å…¥å…ƒç´  $ x $ï¼ŒGELU å°†å…¶ä¹˜ä»¥ä¸€ä¸ªç”±å®ƒè‡ªå·±â€œè¢«æ¿€æ´»çš„æ¦‚çŽ‡â€æ‰€å†³å®šçš„æƒé‡ã€‚
- è¿™ä¸ªâ€œæ¿€æ´»æ¦‚çŽ‡â€ $ P(X \leq x) $ æ¥æºäºŽæ ‡å‡†æ­£æ€åˆ†å¸ƒï¼ˆå‡å€¼ä¸º 0ï¼Œæ ‡å‡†å·®ä¸º 1ï¼‰ã€‚ä½ å¯ä»¥å°†å…¶ç†è§£ä¸ºï¼šåœ¨ä¸€ä¸ªéšæœºæ­£åˆ™åŒ–ï¼ˆå¦‚Dropoutï¼‰çš„æƒ…å¢ƒä¸‹ï¼Œç¥žç»å…ƒæ˜¯å¦è¢«æ¿€æ´»çš„ä¸ç¡®å®šæ€§ã€‚
- å› æ­¤ï¼ŒGELU çš„ç²¾ç¡®å…¬å¼ä¸ºï¼š
  $$
  \text{GELU}(x) = x \cdot P(X \leq x) = x \cdot \Phi(x)
  $$
  å…¶ä¸­ $ \Phi(x) $ æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆCDFï¼‰ï¼Œè®¡ç®—ä¸Šç­‰äºŽ $ \frac{1}{2}(1 + \text{erf}(x / \sqrt{2})) $ã€‚æ‰€ä»¥ç²¾ç¡®å…¬å¼ä¹Ÿå†™ä½œï¼š
  $$
  \text{GELU}(x) = x \cdot \frac{1}{2} \left[ 1 + \text{erf} \left( \frac{x}{\sqrt{2}} \right) \right]
  $$

### âœ¨ ä½¿ç”¨ `approximate="tanh"` çš„åŠ¨æœº

å°½ç®¡æœ‰ç²¾ç¡®å…¬å¼ï¼Œä½†åœ¨å®žé™…åº”ç”¨ä¸­ï¼Œè®¡ç®—è¯¯å·®å‡½æ•° $ \text{erf} $ åœ¨æŸäº›ç¡¬ä»¶ï¼ˆå¦‚GPUï¼‰ä¸Šå¯èƒ½**ä¸å¤Ÿé«˜æ•ˆ**ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç ”ç©¶äººå‘˜æå‡ºäº†ä¸€ä¸ªä½¿ç”¨åŒæ›²æ­£åˆ‡å‡½æ•° $ \tanh $ çš„è¿‘ä¼¼å…¬å¼ï¼Œå®ƒåœ¨ä¿æŒé«˜ç²¾åº¦çš„åŒæ—¶ï¼Œè®¡ç®—é€Ÿåº¦æ›´å¿«ã€‚

å½“ä½ åœ¨ä»£ç ä¸­è®¾ç½® `approximate="tanh"` æ—¶ï¼ŒPyTorch ä¼šä½¿ç”¨ä»¥ä¸‹è¿‘ä¼¼å…¬å¼è¿›è¡Œè®¡ç®—ï¼š
$$
\text{GELU}(x) \approx 0.5 \cdot x \cdot \left( 1 + \tanh \left[ \sqrt{\frac{2}{\pi}} \cdot (x + 0.044715 \cdot x^3) \right] \right)
$$

è¿™ä¸ªè¿‘ä¼¼å…¬å¼é€šè¿‡å¼•å…¥ä¸€ä¸ªä¸‰æ¬¡é¡¹ ($0.044715 x^3$) å’Œ $ \tanh $ å‡½æ•°ï¼Œå·§å¦™åœ°é€¼è¿‘äº†ç²¾ç¡®è®¡ç®—çš„ç»“æžœã€‚

### ðŸ”¢ è¿‘ä¼¼å…¬å¼çš„æŽ¨å¯¼ä¸Žå¸¸é‡æ¥æº

è¿™ä¸ªè¿‘ä¼¼å…¬å¼çš„æŽ¨å¯¼æ—¨åœ¨æ‰¾åˆ°ä¸€ç§è®¡ç®—é«˜æ•ˆçš„æ–¹å¼ï¼Œæ¥é€¼è¿‘æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•° $ \Phi(x) $ã€‚

1.  **é€¼è¿‘ç›®æ ‡**ï¼šç›®æ ‡æ˜¯è¿‘ä¼¼ $ \Phi(x) $ï¼Œå®ƒæ²¡æœ‰åˆç­‰å‡½æ•°å½¢å¼çš„ç²¾ç¡®è¡¨è¾¾å¼ã€‚
2.  **æ•°å­¦å·¥å…·**ï¼šæŽ¨å¯¼è¿‡ç¨‹ä¸­å¯èƒ½åˆ©ç”¨äº† $ \tanh $ å‡½æ•°ä¸Žæ­£æ€åˆ†å¸ƒå½¢çŠ¶çš„æŸç§ç›¸ä¼¼æ€§ï¼Œå¹¶é€šè¿‡**çº§æ•°å±•å¼€**æˆ–**æ•°å€¼æ‹Ÿåˆ**çš„æ–¹æ³•æ¥ä¼˜åŒ–å‚æ•°ã€‚å…³é”®çš„å¸¸æ•° $ \sqrt{\frac{2}{\pi}} $ å’Œ $ 0.044715 $ å°±æ˜¯é€šè¿‡è¿™ç±»æ•°å­¦æ–¹æ³•ç¡®å®šçš„ï¼Œç›®çš„æ˜¯æœ€å°åŒ–è¿‘ä¼¼ç»“æžœä¸Žç²¾ç¡®å€¼ä¹‹é—´çš„è¯¯å·®ã€‚
3.  **æœ€ç»ˆå½¢å¼**ï¼šæœ€ç»ˆå¾—åˆ°çš„å…¬å¼è¢«è¯æ˜Žåœ¨å¸¸è§çš„è¾“å…¥å€¼èŒƒå›´å†…ï¼ˆä¾‹å¦‚ $ x $ åœ¨ `[-10, 10]` åŒºé—´ï¼‰ä¸Žç²¾ç¡®è§£éžå¸¸æŽ¥è¿‘ï¼Œè¯¯å·®é€šå¸¸å¯ä»¥å¿½ç•¥ä¸è®¡ï¼ŒåŒæ—¶è®¡ç®—æ•ˆçŽ‡æ˜¾è‘—æå‡ã€‚

### ðŸ“Š ç²¾ç¡®è®¡ç®—ä¸Žè¿‘ä¼¼è®¡ç®—çš„å¯¹æ¯”

ä¸‹é¢çš„è¡¨æ ¼æ¸…æ™°åœ°å±•ç¤ºäº†ä¸¤ç§è®¡ç®—æ–¹å¼çš„åŒºåˆ«ï¼š

| ç‰¹æ€§ | ç²¾ç¡®è®¡ç®— (`approximate="none"`) | Tanhè¿‘ä¼¼è®¡ç®— (`approximate="tanh"`) |
| :--- | :--- | :--- |
| **æ•°å­¦å…¬å¼** | $ x \cdot \frac{1}{2} \left[ 1 + \text{erf}(x / \sqrt{2}) \right] $ | $ 0.5 \cdot x \cdot \left( 1 + \tanh \left[ \sqrt{\frac{2}{\pi}} \cdot (x + 0.044715 \cdot x^3) \right] \right) $ |
| **è®¡ç®—æ ¸å¿ƒ** | è¯¯å·®å‡½æ•° $ \text{erf} $ | åŒæ›²æ­£åˆ‡å‡½æ•° $ \tanh $ |
| **è®¡ç®—æ•ˆçŽ‡** | ç›¸å¯¹è¾ƒä½Žï¼ˆåœ¨æŸäº›ç¡¬ä»¶ä¸Šï¼‰ | **ç›¸å¯¹è¾ƒé«˜**ï¼Œå¯¹GPUå‹å¥½ |
| **ç²¾åº¦** | ç²¾ç¡® | **é«˜ç²¾åº¦è¿‘ä¼¼**ï¼Œé€šå¸¸æ»¡è¶³æ¨¡åž‹éœ€æ±‚ |
| **é€‚ç”¨åœºæ™¯** | å¯¹æ•°å€¼ç²¾åº¦æœ‰æžè‡´è¦æ±‚çš„åœºæ™¯ | **ç»å¤§å¤šæ•°æ·±åº¦å­¦ä¹ è®­ç»ƒå’ŒæŽ¨ç†åœºæ™¯** |

### ðŸ’¡ ä¸ºä»€ä¹ˆåœ¨æ¨¡åž‹ä¸­ä½¿ç”¨ Tanh è¿‘ä¼¼ï¼Ÿ

åœ¨ SigLIP æˆ– BERTã€GPT ç­‰çŽ°ä»£Transformeræž¶æž„ä¸­ï¼Œæ™®éé‡‡ç”¨ `approximate="tanh"`ï¼Œä¸»è¦åŸºäºŽä»¥ä¸‹è€ƒè™‘ï¼š

- **æ€§èƒ½ä¼˜åŒ–**ï¼šåœ¨GPUç­‰å¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—ç¡¬ä»¶ä¸Šï¼Œè®¡ç®— $ \tanh $ é€šå¸¸æ¯”è®¡ç®— $ \text{erf} $ æ›´é«˜æ•ˆï¼Œèƒ½æœ‰æ•ˆåŠ é€Ÿè®­ç»ƒå’ŒæŽ¨ç†è¿‡ç¨‹ã€‚
- **è¶³å¤Ÿçš„ç²¾åº¦**ï¼šå¯¹äºŽæ·±åº¦å­¦ä¹ ä»»åŠ¡ï¼Œè¿™ç§è¿‘ä¼¼å¸¦æ¥çš„å¾®å°ç²¾åº¦æŸå¤±å¯¹æ¨¡åž‹çš„æœ€ç»ˆæ€§èƒ½å½±å“å¾®ä¹Žå…¶å¾®ï¼Œæ˜¯å®Œå…¨å¯æŽ¥å—çš„ã€‚
- **å®žè·µæ ‡å‡†**ï¼šå®ƒå·²æˆä¸ºè®¸å¤šå¼€æºæ¨¡åž‹å®žçŽ°ä¸­çš„**äº‹å®žæ ‡å‡†**ï¼Œç¡®ä¿äº†ä»£ç çš„é€šç”¨æ€§å’Œå¯å¤çŽ°æ€§ã€‚

### ðŸ’Ž æ€»ç»“

ç®€å•æ¥è¯´ï¼Œ`nn.functional.gelu(hidden_states, approximate="tanh")` æ˜¯ GELU æ¿€æ´»å‡½æ•°çš„ä¸€ç§**è®¡ç®—é«˜æ•ˆä¸”ç²¾åº¦è‰¯å¥½çš„å®žçŽ°ç‰ˆæœ¬**ã€‚å®ƒé€šè¿‡ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ã€åŒ…å« $ \tanh $ å‡½æ•°çš„å…¬å¼æ¥é€¼è¿‘ç²¾ç¡®çš„æ•°å­¦å®šä¹‰ï¼Œåœ¨ä¿æŒ GELU å¹³æ»‘ã€æ¦‚çŽ‡åŒ–ä¼˜è‰¯ç‰¹æ€§çš„åŒæ—¶ï¼Œæå‡äº†æ¨¡åž‹çš„è®¡ç®—é€Ÿåº¦ï¼Œæ˜¯çŽ°ä»£æ·±åº¦å­¦ä¹ æ¨¡åž‹ä¸­çš„å¸¸è§é€‰æ‹©ã€‚

## 3.2 SiglipVisionModelæºç åˆ†æž

### 1. SiglipEncoderLayerï¼šæ ¸å¿ƒå˜æ¢å•å…ƒ

`SiglipEncoderLayer` æ˜¯Transformeræž¶æž„ä¸­çš„åŸºæœ¬æž„å»ºå—ï¼Œæ¯ä¸ªç¼–ç å±‚åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒå­æ¨¡å—ï¼Œå¹¶é‡‡ç”¨æ®‹å·®è¿žæŽ¥ ã€‚

```python
def forward(self, hidden_states: torch.Tensor) -> torch.Tensor:
    # ç¬¬ä¸€éƒ¨åˆ†: è‡ªæ³¨æ„åŠ›æœºåˆ¶
    residual = hidden_states  # æ®‹å·®è¿žæŽ¥
    hidden_states = self.layer_norm1(hidden_states)  # é¢„å±‚å½’ä¸€åŒ–
    hidden_states, _ = self.self_attn(hidden_states=hidden_states)  # è‡ªæ³¨æ„åŠ›
    hidden_states = residual + hidden_states  # æ®‹å·®è¿žæŽ¥
    
    # ç¬¬äºŒéƒ¨åˆ†: å‰é¦ˆç¥žç»ç½‘ç»œ
    residual = hidden_states  # æ®‹å·®è¿žæŽ¥
    hidden_states = self.layer_norm2(hidden_states)  # é¢„å±‚å½’ä¸€åŒ–
    hidden_states = self.mlp(hidden_states)  # å‰é¦ˆç½‘ç»œ
    hidden_states = residual + hidden_states  # æ®‹å·®è¿žæŽ¥
    
    return hidden_states
```

**å…³é”®æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- **é¢„å±‚å½’ä¸€åŒ–**ï¼šåœ¨è‡ªæ³¨æ„åŠ›å’ŒMLPä¹‹å‰è¿›è¡Œå±‚å½’ä¸€åŒ–ï¼Œæœ‰åŠ©äºŽè®­ç»ƒç¨³å®šæ€§ 
- **æ®‹å·®è¿žæŽ¥**ï¼šæ¯ä¸ªå­å±‚çš„è¾“å‡ºéƒ½ä¸Žè¾“å…¥ç›¸åŠ ï¼Œç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œä½¿æ·±å±‚ç½‘ç»œæ˜“äºŽè®­ç»ƒ 
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šè‡ªæ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ç»œåˆ†ç¦»ï¼Œå„å¸å…¶èŒ

### 2. SiglipEncoderï¼šå¤šå±‚å †å 

`SiglipEncoder` å°†å¤šä¸ª `SiglipEncoderLayer` å †å èµ·æ¥ï¼Œå½¢æˆæ·±åº¦ç½‘ç»œç»“æž„ã€‚

```python
class SiglipEncoder(nn.Module):
    def __init__(self, config: SiglipVisionConfig):
        super().__init__()
        self.layers = nn.ModuleList(
            [SiglipEncoderLayer(config) for _ in range(config.num_hidden_layers)]  # å †å å¤šå±‚
        )

    def forward(self, inputs_embeds: torch.Tensor) -> torch.Tensor:
        hidden_states = inputs_embeds
        for encoder_layer in self.layers:  # é€å±‚å¤„ç†
            hidden_states = encoder_layer(hidden_states)
        return hidden_states
```

### 3. SiglipVisionTransformerï¼šè§†è§‰ç¼–ç ä¸»å¹²

`SiglipVisionTransformer` æ˜¯å®Œæ•´çš„è§†è§‰ç¼–ç ç®¡é“ï¼ŒåŒ…å«åµŒå…¥å±‚ã€ç¼–ç å™¨å’ŒåŽå¤„ç†å½’ä¸€åŒ–ã€‚

```python
class SiglipVisionTransformer(nn.Module):
    def __init__(self, config: SiglipVisionConfig):
        super().__init__()
        self.embeddings = SiglipVisionEmbeddings(config)  # å›¾åƒ->åºåˆ—
        self.encoder = SiglipEncoder(config)  # åºåˆ—ç¼–ç 
        self.post_layernorm = nn.LayerNorm(embed_dim, eps=config.layer_norm_eps)  # æœ€ç»ˆå½’ä¸€åŒ–

    def forward(self, pixel_values: torch.Tensor) -> torch.Tensor:
        hidden_states = self.embeddings(pixel_values)  # ç”ŸæˆpatchåµŒå…¥
        last_hidden_state = self.encoder(hidden_states)  # é€šè¿‡ç¼–ç å™¨
        last_hidden_state = self.post_layernorm(last_hidden_state)  # æœ€ç»ˆå½’ä¸€åŒ–
        return last_hidden_state
```

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š
- **åµŒå…¥å±‚**ï¼šå°†å›¾åƒåˆ†å‰²ä¸ºpatchå¹¶çº¿æ€§æŠ•å½±ä¸ºåºåˆ—å‘é‡ 
- **åŽå±‚å½’ä¸€åŒ–**ï¼šå¯¹æœ€ç»ˆè¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–ï¼Œç¡®ä¿æ•°å€¼ç¨³å®šæ€§ 

### 4. SiglipVisionModelï¼šæ¨¡åž‹å°è£…å™¨

`SiglipVisionModel` æ˜¯æœ€å¤–å±‚çš„å°è£…ï¼Œä¸ºè§†è§‰ç¼–ç å™¨æä¾›ç»Ÿä¸€çš„æŽ¥å£ã€‚

```python
class SiglipVisionModel(nn.Module):
    def __init__(self, config: SiglipVisionConfig):
        super().__init__()
        self.vision_model = SiglipVisionTransformer(config)  # åŒ…å«å®Œæ•´è§†è§‰ç¼–ç å™¨

    def forward(self, pixel_values) -> Tuple:
        return self.vision_model(pixel_values=pixel_values)  # å§”æ‰˜ç»™å†…éƒ¨æ¨¡åž‹
```
